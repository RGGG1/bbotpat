<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>/ HiveAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="favicon.svg" />
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      margin: 0;
      padding: 24px;
    }
    .app {
      max-width: 1100px;
      margin: 0 auto;
    }
    header {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 24px;
    }
    .slash {
      display: inline-block;
      margin-right: 6px;
      transition: color 0.3s ease;
    }
    .row { margin-bottom: 28px; }
    .section-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 12px;
      color: #bbb;
    }
    .hmi-value {
      font-size: 48px;
      font-weight: 600;
    }
    .hmi-status {
      font-size: 18px;      /* same as section-title */
      margin-left: 12px;
      color: #fff;          /* white */
    }

    .dom-block, .prices-block {
      padding: 16px 0;
      border-top: 1px solid #222;
    }

    .dom-main {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }
    .dom-value {
      font-size: 48px;      /* same as HMI number */
      font-weight: 600;
    }
    .dom-label {
      font-size: 18px;      /* same as section-title */
      font-weight: 500;
      color: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }
    th {
      text-align: left;
      font-weight: 600;
      color: #bbb;
      padding: 6px 4px;
    }
    td {
      padding: 6px 4px;
    }

    /* Center all columns except the token name (first column) */
    th:nth-child(n+2),
    td:nth-child(n+2) {
      text-align: center;
    }

    .red {
      color: #ff4b5c;
    }
    .green {
      color: #4dff88;
    }

    footer {
      margin-top: 40px;
      font-size: 12px;
      color: #777;
      line-height: 1.5;
    }

    /* Mobile tweaks */
    @media (max-width: 640px) {
      body {
        padding: 16px;
      }
      header {
        font-size: 26px;
      }
      .hmi-value {
        font-size: 38px;
      }
      .dom-value {
        font-size: 38px;
      }
      table {
        font-size: 12px;
      }
      th, td {
        padding: 4px 3px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header><span class="slash" id="slash">/</span>HiveAI</header>

  <!-- HMI -->
  <div class="row" id="hmi-section">
    <div class="section-title">Hive Mind Index</div>
    <div class="hmi-value">
      <span id="hmi-val">--.-</span>
      <span class="hmi-status" id="hmi-status">loading</span>
    </div>
  </div>

  <!-- Dominance -->
  <div class="dom-block" id="dom-section">
    <div class="section-title">Dominance</div>
    <div class="dom-main">
      <span class="dom-value" id="dom-value">--</span>
      <span class="dom-label">BTC vs EthBnbSol</span>
    </div>
    <div id="dom-range">2-yr range: --% – --%</div>
    <div id="dom-caps">Market caps: --</div>
    <div id="dom-action" style="margin-top:8px;">Action: --</div>
  </div>

  <!-- Prices -->
  <div class="prices-block" id="prices-section">
    <div class="section-title">Prices</div>
    <table id="prices-table">
      <thead>
        <tr>
          <th>Token</th>
          <th>Price</th>
          <th>MC</th>
          <th>24h</th>
          <th>BTC Dom</th>
          <th>Range</th>
        </tr>
      </thead>
      <tbody id="prices-body">
        <tr><td colspan="6">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <footer>
    <strong>Refresh rates</strong><br/>
    HMI: every 60s.<br/>
    Dominance: every 6h.<br/>
    Prices: on page load.
  </footer>

</div>

<script>
  // ---------- UTILITIES ----------
  function fmtNum(v){
    return Number(v).toLocaleString();
  }
  function mcFmt(v){
    if(!v || v <= 0) return "$0";
    if(v >= 1e12) return "$" + (v/1e12).toFixed(1) + "T";
    if(v >= 1e9)  return "$" + (v/1e9).toFixed(1) + "B";
    if(v >= 1e6)  return "$" + (v/1e6).toFixed(1) + "M";
    return "$" + Math.round(v).toLocaleString();
  }
  function colorSlash(hmi){
    const s = document.getElementById("slash");
    if (isNaN(hmi)) {
      s.style.color = "#fff";
      return;
    }
    s.style.color = (hmi < 40) ? "#ff4b5c" : (hmi > 60 ? "#4dff88" : "#fff");
  }

  // ---------- HMI ----------
  async function loadHMI(){
    try{
      const r = await fetch("hmi_latest.json",{cache:"no-store"});
      const j = await r.json();
      const h = Number(j.hmi);
      const band = j.band || "";
      if (!isNaN(h)) {
        document.getElementById("hmi-val").textContent = h.toFixed(1);
        document.getElementById("hmi-status").textContent = band;
        colorSlash(h);
      }
    }catch(e){
      console.error("HMI", e);
    }
  }

  // ---------- DOMINANCE ----------
  async function loadDom(){
    try{
      const r = await fetch("dom_bands_latest.json",{cache:"no-store"});
      const j = await r.json();
      const btcPct = j.btc_pct;
      const minPct = j.min_pct;
      const maxPct = j.max_pct;

      if (btcPct != null) {
        // e.g. "77 BTC vs EthBnbSol"
        document.getElementById("dom-value").textContent = Math.round(btcPct);
      }

      if (minPct != null && maxPct != null) {
        document.getElementById("dom-range").textContent =
          `2-yr range: ${Math.round(minPct)}% – ${Math.round(maxPct)}%`;
      }

      const caps = `Market caps: ${j.btc_mc_fmt || "--"} vs ${j.alt_mc_fmt || "--"}`;
      document.getElementById("dom-caps").textContent = caps;

      const action = j.action || "--";
      document.getElementById("dom-action").textContent = `Action: ${action}`;
    }catch(e){
      console.error("DOM", e);
    }
  }

  // ---------- PRICES ----------
  // format "60.0–80.3" => "60%–80%"
  function formatRange(rng) {
    if (!rng || typeof rng !== "string") return "";
    const parts = rng.split("–");
    if (parts.length !== 2) return rng;
    const lo = Math.round(parseFloat(parts[0]));
    const hi = Math.round(parseFloat(parts[1]));
    if (isNaN(lo) || isNaN(hi)) return rng;
    return `${lo}%–${hi}%`;
  }

  async function loadPrices(){
    try{
      const r = await fetch("prices_latest.json",{cache:"no-store"});
      const j = await r.json();
      const body = document.getElementById("prices-body");
      body.innerHTML = "";

      if (!j.rows || !Array.isArray(j.rows) || j.rows.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6">No data</td>`;
        body.appendChild(tr);
        return;
      }

      j.rows.forEach(row => {
        const tr = document.createElement("tr");

        const token = row.token || "";
        const price = row.price != null ? `$${fmtNum(row.price)}` : "--";
        const mc = mcFmt(row.mc || 0);
        const change = Number(row.change_24h || 0);
        const btcDom = row.btc_dom != null ? `${row.btc_dom}` : "";
        const range = formatRange(row.range || "");

        // 24h colour class
        let changeClass = "";
        if (change > 0) changeClass = "green";
        else if (change < 0) changeClass = "red";

        tr.innerHTML = `
          <td>${token}</td>
          <td>${price}</td>
          <td>${mc}</td>
          <td class="${changeClass}">${change.toFixed(1)}%</td>
          <td>${btcDom}</td>
          <td>${range}</td>
        `;
        body.appendChild(tr);
      });
    }catch(e){
      console.error("Prices", e);
    }
  }

  // ---------- INIT ----------
  loadHMI();
  loadDom();
  loadPrices();
  setInterval(loadHMI, 60000);
  setInterval(loadDom, 21600000); // 6h
</script>

</body>
</html>
