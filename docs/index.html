<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>/ HiveAI – Hive Mind Index & Dominance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #000000;
      --bg-elevated: #050509;
      --border-subtle: #22232f;
      --text-main: #f5f5f7;
      --text-muted: #888aa0;
      --accent-red: #ff4b5c;
      --accent-green: #4dff88;
      --accent-neutral: #ffffff;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
                   "Inter", "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text-main);
      font-family: var(--font-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1040px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .title-stack {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .logo-slash {
      font-size: 24px;
      line-height: 1;
      transition: color 0.28s ease;
    }

    .logo-hive {
      transition: color 0.28s ease;
    }

    .logo-ai {
      color: var(--text-main);
      opacity: 0.9;
    }

    .logo-accent-red {
      color: var(--accent-red);
    }

    .logo-accent-green {
      color: var(--accent-green);
    }

    .logo-accent-neutral {
      color: var(--accent-neutral);
    }

    .meta-topline {
      text-align: right;
      font-size: 11px;
      color: var(--text-muted);
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .grid-top {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 16px;
    }

    @media (max-width: 800px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
      .meta-topline {
        text-align: left;
      }
      .grid-top {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--bg-elevated);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.45);
      padding: 10px 12px 12px;
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .chip {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #11111a;
      border: 1px solid #232332;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }

    /* HMI section */
    .hmi-value-row {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 6px;
    }

    .hmi-value {
      font-size: 36px;
      font-weight: 600;
    }

    .hmi-status {
      font-size: 12px;       /* same size as "Hive Mind Index" title */
      font-weight: 500;
      color: var(--accent-neutral); /* white */
      text-transform: lowercase;
    }

    /* Dominance (main BTC vs Alts) */
    .dom-main-line {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .dom-main-line .dom-value {
      font-size: 36px;
      font-weight: 600;
      margin-right: 6px;
    }

    .dom-main-line .dom-label {
      font-size: 13px;
      color: var(--accent-neutral);
    }

    .dom-sub-line {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .dom-sub-line span {
      color: var(--text-main);
    }

    .dom-range-line {
      font-size: 11px;
      color: var(--text-muted);
    }

    .dom-range-line span {
      color: var(--text-main);
    }

    .dom-action {
      font-size: 11px;
      color: var(--text-main);
      margin-top: 6px;
    }

    /* Dominance Oracle */
    .oracle-card {
      margin-top: 2px;
    }

    .oracle-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .oracle-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 11px;
      color: var(--text-muted);
    }

    .oracle-controls label {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .oracle-select {
      background: #050509;
      border-radius: 4px;
      border: 1px solid #303040;
      color: var(--text-main);
      font-size: 11px;
      padding: 2px 4px;
      min-width: 80px;
    }

    .oracle-select option {
      background: #050509;
      color: var(--text-main);
    }

    .oracle-vs {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .oracle-main-line {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .oracle-main-line .dom-value {
      font-size: 24px;
      font-weight: 600;
      margin-right: 6px;
    }

    .oracle-main-line .dom-label {
      font-size: 13px;
      color: var(--accent-neutral);
    }

    .oracle-sub-line,
    .oracle-range-line,
    .oracle-note,
    .oracle-error {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .oracle-sub-line span,
    .oracle-range-line span {
      color: var(--text-main);
    }

    .oracle-note {
      margin-top: 4px;
      font-style: italic;
    }

    .oracle-error {
      color: var(--accent-red);
      margin-top: 4px;
    }

    /* Prices table */
    .prices-card {
      margin-top: 4px;
    }

    .prices-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
    }

    .prices-table thead {
      border-bottom: 1px solid var(--border-subtle);
    }

    .prices-table th,
    .prices-table td {
      padding: 6px 4px;
    }

    .prices-table th {
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      font-size: 10px;
      color: var(--text-muted);
    }

    .prices-table th.token-col,
    .prices-table td.token-col {
      text-align: left;
    }

    .prices-table th.center,
    .prices-table td.center {
      text-align: center;
    }

    .prices-table tbody tr {
      border-bottom: 1px solid #11111a;
    }

    .prices-table tbody tr:last-child {
      border-bottom: none;
    }

    .prices-table tbody tr:nth-child(even) {
      background: #070711;
    }

    .prices-table tbody tr:nth-child(odd) {
      background: #050509;
    }

    .price-positive {
      color: var(--accent-green);
    }

    .price-negative {
      color: var(--accent-red);
    }

    .price-neutral {
      color: var(--text-main);
    }

    .footer-note {
      margin-top: 14px;
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .footer-note-title {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 10px;
      margin-bottom: 2px;
    }

    @media (max-width: 700px) {
      .prices-table {
        font-size: 11px;
      }
      .prices-table th,
      .prices-table td {
        padding: 5px 3px;
      }
      .hmi-value {
        font-size: 32px;
      }
      .dom-main-line .dom-value,
      .oracle-main-line .dom-value {
        font-size: 30px;
      }
      .oracle-controls {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="title-stack">
        <span id="logo-slash" class="logo-slash logo-accent-neutral">/</span>
        <span class="logo-wordmark">
          <span id="logo-hive" class="logo-hive logo-accent-neutral">Hive</span><span class="logo-ai">AI</span>
        </span>
      </div>
      <div class="meta-topline">
        Updated: <span id="meta-date">--/--/-- --:--</span>
      </div>
    </header>

    <main>
      <div class="grid-top">
        <!-- HMI CARD -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">Hive Mind Index</div>
          </div>
          <div class="hmi-value-row">
            <div class="hmi-value" id="hmi-value">--.-</div>
            <div class="hmi-status" id="hmi-status">–</div>
          </div>
        </section>

        <!-- DOMINANCE CARD -->
        <section class="card">
          <div class="card-header">
            <div class="card-title">Dominance</div>
            <div class="chip">BTC vs Alts</div>
          </div>
          <div class="dom-main-line" id="dom-main-line">
            <span class="dom-value">--</span>
            <span class="dom-label">BTC vs Alts</span>
          </div>
          <div class="dom-sub-line" id="dom-sub-line">
            Market caps: <span>–</span>
          </div>
          <div class="dom-range-line" id="dom-range-line">
            2-yr range: <span>–</span>
          </div>
          <div class="dom-action" id="dom-action">
            Action: –
          </div>
        </section>
      </div>

      <!-- DOMINANCE ORACLE -->
      <section class="card oracle-card">
        <div class="oracle-header-row">
          <div class="card-title">Dominance Oracle</div>
          <div class="oracle-controls">
            <label>
              X
              <select id="oracle-x" class="oracle-select" multiple size="1"></select>
            </label>
            <span class="oracle-vs">vs</span>
            <label>
              Y
              <select id="oracle-y" class="oracle-select" multiple size="1"></select>
            </label>
          </div>
        </div>
        <div class="oracle-main-line" id="oracle-main-line">
          <span class="dom-value">--</span>
          <span class="dom-label">Select X and Y</span>
        </div>
        <div class="oracle-sub-line" id="oracle-sub-line">
          Market caps: <span>–</span>
        </div>
        <div class="oracle-range-line" id="oracle-range-line">
          Range: <span>–</span>
        </div>
        <div class="oracle-note">
          Retrieve via HiveAI API
        </div>
        <div class="oracle-error" id="oracle-error"></div>
      </section>

      <!-- PRICES / TOKENS CARD -->
      <section class="card prices-card">
        <div class="card-header">
          <div class="card-title">Tokens</div>
        </div>
        <table class="prices-table">
          <thead>
            <tr>
              <th class="token-col">Token</th>
              <th class="center">Price</th>
              <th class="center">MC</th>
              <th class="center">24h</th>
              <th class="center">Dom</th>
              <th class="center">Range</th>
            </tr>
          </thead>
          <tbody id="prices-tbody">
            <!-- rows injected by JS -->
          </tbody>
        </table>

        <div class="footer-note">
          <div class="footer-note-title">HiveAI Oracle Notes</div>
          <div>
            <ul style="margin-top:6px;line-height:1.35;list-style:disc;padding-left:18px;">
              <li>Hive Mind Index (HMI) is our custom fear and greed index, factored for predictive signaling.</li>
              <li>HMI and Dom values updated every 12 hours, at 07:15 and 19:15 CEST.</li>
              <li>'Dom' represents BTC dominance against token.</li>
              <li>'Range' represents up to 2-year BTC Dom range against token.</li>
              <li>USDTC = USDT and USDC combined.</li>
              <li>Additional token listing available on request.</li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const HMI_NEUTRAL_LOW = 40;
    const HMI_NEUTRAL_HIGH = 60;

    // Tokens available in the Dominance Oracle (no USDTC to keep things clean)
    const ORACLE_TOKENS = [
      "BTC",
      "ETH",
      "BNB",
      "SOL",
      "DOGE",
      "TON",
      "SUI",
      "UNI"
    ];

    // Map token -> Binance symbol
    const BINANCE_SYMBOLS = {
      BTC: "BTCUSDT",
      ETH: "ETHUSDT",
      BNB: "BNBUSDT",
      SOL: "SOLUSDT",
      DOGE: "DOGEUSDT",
      TON: "TONUSDT",
      SUI: "SUIUSDT",
      UNI: "UNIUSDT"
    };

    let pricesRowsGlobal = [];
    let suppliesGlobal = null;  // loaded lazily from supplies_latest.json
    let oracleHistories = {};   // token -> { dateString -> closePrice }

    function formatDateTime(ts) {
      if (!ts) return "--/--/-- --:--";
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yy = String(d.getFullYear()).slice(-2);
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${dd}/${mm}/${yy} ${hh}:${mi}`;
    }

    function formatMC(v) {
      if (!v || v <= 0) return "$0";
      if (v >= 1e12) {
        return `$${(v / 1e12).toFixed(1)}T`;
      }
      if (v >= 1e9) {
        return `$${Math.round(v / 1e9)}B`;
      }
      if (v >= 1e6) {
        return `$${Math.round(v / 1e6)}M`;
      }
      return `$${Math.round(v).toLocaleString()}`;
    }

    function updateLogoColor(hmi) {
      const slashEl = document.getElementById("logo-slash");
      const hiveEl = document.getElementById("logo-hive");

      if (!slashEl || !hiveEl) return;

      slashEl.classList.remove("logo-accent-red", "logo-accent-green", "logo-accent-neutral");
      hiveEl.classList.remove("logo-accent-red", "logo-accent-green", "logo-accent-neutral");

      if (typeof hmi !== "number" || Number.isNaN(hmi)) {
        slashEl.classList.add("logo-accent-neutral");
        hiveEl.classList.add("logo-accent-neutral");
        return;
      }

      if (hmi < HMI_NEUTRAL_LOW) {
        slashEl.classList.add("logo-accent-red");
        hiveEl.classList.add("logo-accent-red");
      } else if (hmi > HMI_NEUTRAL_HIGH) {
        slashEl.classList.add("logo-accent-green");
        hiveEl.classList.add("logo-accent-green");
      } else {
        slashEl.classList.add("logo-accent-neutral");
        hiveEl.classList.add("logo-accent-neutral");
      }
    }

    function hmiBandLabel(hmi) {
      if (hmi < 10) return "zombie apocalypse";
      if (hmi < 25) return "McDonald's applications";
      if (hmi < 40) return "ngmi";
      if (hmi < 60) return "stable";
      if (hmi < 80) return "we're early";
      return "it's the future of finance";
    }

    async function fetchHMI() {
      try {
        const resp = await fetch("hmi_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("HMI fetch failed");
        const data = await resp.json();

        const hmiRaw = (typeof data.hmi === "number") ? data.hmi : parseFloat(data.hmi);
        const hmi = Number.isNaN(hmiRaw) ? null : hmiRaw;

        if (hmi === null) {
          throw new Error("Invalid HMI in JSON");
        }

        const hmiEl = document.getElementById("hmi-value");
        const statusEl = document.getElementById("hmi-status");
        if (hmiEl) hmiEl.textContent = hmi.toFixed(1);
        if (statusEl) statusEl.textContent = hmiBandLabel(hmi);

        updateLogoColor(hmi);
      } catch (err) {
        console.error("HMI error:", err);
        const hmiEl = document.getElementById("hmi-value");
        const statusEl = document.getElementById("hmi-status");
        if (hmiEl) hmiEl.textContent = "--.-";
        if (statusEl) statusEl.textContent = "unavailable";
        updateLogoColor(NaN);
      }
    }

    async function fetchDominance() {
      try {
        const resp = await fetch("dom_bands_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("Dominance fetch failed");
        const data = await resp.json();

        const btcPct = typeof data.btc_pct === "number"
          ? data.btc_pct
          : parseFloat(data.btc_pct || "0");
        const minPct = typeof data.min_pct === "number"
          ? data.min_pct
          : parseFloat(data.min_pct || "0");
        const maxPct = typeof data.max_pct === "number"
          ? data.max_pct
          : parseFloat(data.max_pct || "0");

        const btcFmt = Number.isNaN(btcPct) ? "--" : btcPct.toFixed(1);

        const domMainEl = document.getElementById("dom-main-line");
        domMainEl.innerHTML =
          `<span class="dom-value">${btcFmt}</span><span class="dom-label">BTC vs Alts</span>`;

        const mcLine = `Market caps: <span>${data.btc_mc_fmt || "–"} vs ${data.alt_mc_fmt || "–"}</span>`;
        document.getElementById("dom-sub-line").innerHTML = mcLine;

        let rangeTxt = "–";
        if (!Number.isNaN(minPct) && !Number.isNaN(maxPct) && maxPct >= minPct) {
          rangeTxt = `${Math.round(minPct)}–${Math.round(maxPct)}%`;
        }
        document.getElementById("dom-range-line").innerHTML =
          `2-yr range: <span>${rangeTxt}</span>`;

        const action = data.action || "–";
        document.getElementById("dom-action").textContent = `Action: ${action}`;
      } catch (err) {
        console.error("Dominance error:", err);
        document.getElementById("dom-main-line").innerHTML =
          `<span class="dom-value">--</span><span class="dom-label">BTC vs Alts</span>`;
        document.getElementById("dom-sub-line").innerHTML =
          `Market caps: <span>unavailable</span>`;
        document.getElementById("dom-range-line").innerHTML =
          `2-yr range: <span>--</span>`;
        document.getElementById("dom-action").textContent = "Action: –";
      }
    }

    async function fetchPrices() {
      try {
        const resp = await fetch("prices_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("prices fetch failed");
        const data = await resp.json();

        const metaEl = document.getElementById("meta-date");
        if (metaEl && data && data.timestamp) {
          metaEl.textContent = formatDateTime(data.timestamp);
        }

        const tbody = document.getElementById("prices-tbody");
        tbody.innerHTML = "";

        const rows = Array.isArray(data.rows) ? data.rows : [];
        pricesRowsGlobal = rows; // store for oracle

        rows.forEach(row => {
          const tr = document.createElement("tr");

          const tdToken = document.createElement("td");
          tdToken.className = "token-col";
          tdToken.textContent = row.token || "";
          tr.appendChild(tdToken);

          const tdPrice = document.createElement("td");
          tdPrice.className = "center";
          const priceVal = typeof row.price === "number" ? row.price : parseFloat(row.price || "0");
          if (!Number.isNaN(priceVal) && priceVal > 0) {
            if (priceVal >= 1000) {
              tdPrice.textContent = "$" + Math.round(priceVal).toLocaleString();
            } else {
              tdPrice.textContent = "$" + priceVal.toFixed(2);
            }
          } else {
            tdPrice.textContent = "–";
          }
          tr.appendChild(tdPrice);

          const tdMC = document.createElement("td");
          tdMC.className = "center";
          tdMC.textContent = formatMC(row.mc || 0);
          tr.appendChild(tdMC);

          const tdChange = document.createElement("td");
          tdChange.className = "center";
          const ch = typeof row.change_24h === "number"
            ? row.change_24h
            : parseFloat(row.change_24h || "0");
          if (Number.isNaN(ch)) {
            tdChange.textContent = "–";
            tdChange.classList.add("price-neutral");
          } else {
            const sign = ch > 0 ? "+" : "";
            tdChange.textContent = `${sign}${ch.toFixed(1)}%`;
            if (ch > 0) {
              tdChange.classList.add("price-positive");
            } else if (ch < 0) {
              tdChange.classList.add("price-negative");
            } else {
              tdChange.classList.add("price-neutral");
            }
          }
          tr.appendChild(tdChange);

          const tdDom = document.createElement("td");
          tdDom.className = "center";
          const dom = typeof row.btc_dom === "number" ? row.btc_dom : null;
          if (dom === null || Number.isNaN(dom)) {
            tdDom.textContent = "–";
          } else {
            tdDom.textContent = dom.toFixed(1) + "%";
          }
          tr.appendChild(tdDom);

          const tdRange = document.createElement("td");
          tdRange.className = "center";
          tdRange.textContent = row.range || "–";
          tr.appendChild(tdRange);

          tbody.appendChild(tr);
        });

        // once prices are loaded, we can initialize oracle dropdowns
        initOracleSelects();
      } catch (err) {
        console.error("Prices error:", err);
        const tbody = document.getElementById("prices-tbody");
        tbody.innerHTML = "";
      }
    }

    // ---------- Dominance Oracle logic ----------

    function initOracleSelects() {
      const selX = document.getElementById("oracle-x");
      const selY = document.getElementById("oracle-y");
      if (!selX || !selY) return;

      if (selX.options.length === 0) {
        ORACLE_TOKENS.forEach(tok => {
          const optX = document.createElement("option");
          optX.value = tok;
          optX.textContent = tok;
          selX.appendChild(optX);

          const optY = document.createElement("option");
          optY.value = tok;
          optY.textContent = tok;
          selY.appendChild(optY);
        });

        selX.addEventListener("change", updateOracle);
        selY.addEventListener("change", updateOracle);
      }
    }

    function getSelectedTokens(selectEl) {
      const out = [];
      for (let i = 0; i < selectEl.options.length; i++) {
        const opt = selectEl.options[i];
        if (opt.selected) out.push(opt.value);
      }
      return out;
    }

    async function fetchSuppliesIfNeeded() {
      if (suppliesGlobal !== null) return;
      try {
        const resp = await fetch("supplies_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("supplies fetch failed");
        const data = await resp.json();
        suppliesGlobal = data.supplies || {};
      } catch (err) {
        console.error("Supplies error:", err);
        suppliesGlobal = {};
      }
    }

    async function ensurePriceHistory(token) {
      if (oracleHistories[token]) return;
      const symbol = BINANCE_SYMBOLS[token];
      if (!symbol) {
        oracleHistories[token] = {};
        return;
      }
      const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1d&limit=730`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Binance klines error for ${token}`);
      const data = await resp.json();
      const hist = {};
      for (const k of data) {
        const openTimeMs = k[0];
        const closePrice = parseFloat(k[4]);
        const d = new Date(openTimeMs).toISOString().slice(0, 10); // YYYY-MM-DD
        hist[d] = closePrice;
      }
      oracleHistories[token] = hist;
    }

    function getLiveMC(token) {
      const row = pricesRowsGlobal.find(r => r.token === token);
      if (!row) return 0;
      return typeof row.mc === "number" ? row.mc : parseFloat(row.mc || "0") || 0;
    }

    function getLivePrice(token) {
      const row = pricesRowsGlobal.find(r => r.token === token);
      if (!row) return 0;
      const v = row.price;
      if (typeof v === "number") return v;
      const p = parseFloat(v || "0");
      return Number.isNaN(p) ? 0 : p;
    }

    function getSupply(token) {
      if (!suppliesGlobal) return 0;
      const entry = suppliesGlobal[token];
      if (!entry) return 0;
      const val = entry.circulating_supply;
      if (typeof val === "number") return val;
      const f = parseFloat(val || "0");
      return Number.isNaN(f) ? 0 : f;
    }

    async function updateOracle() {
      const mainEl = document.getElementById("oracle-main-line");
      const subEl = document.getElementById("oracle-sub-line");
      const rangeEl = document.getElementById("oracle-range-line");
      const errEl = document.getElementById("oracle-error");

      if (!mainEl || !subEl || !rangeEl || !errEl) return;

      errEl.textContent = "";

      const selX = document.getElementById("oracle-x");
      const selY = document.getElementById("oracle-y");
      if (!selX || !selY) return;

      const setX = getSelectedTokens(selX);
      const setY = getSelectedTokens(selY);

      if (setX.length === 0 || setY.length === 0) {
        mainEl.innerHTML = `<span class="dom-value">--</span><span class="dom-label">Select X and Y</span>`;
        subEl.innerHTML = `Market caps: <span>–</span>`;
        rangeEl.innerHTML = `Range: <span>–</span>`;
        return;
      }

      const intersect = setX.filter(t => setY.includes(t));
      if (intersect.length > 0) {
        errEl.textContent = "X and Y must not share the same token.";
        mainEl.innerHTML = `<span class="dom-value">--</span><span class="dom-label">Invalid selection</span>`;
        subEl.innerHTML = `Market caps: <span>–</span>`;
        rangeEl.innerHTML = `Range: <span>–</span>`;
        return;
      }

      // Ensure we have supplies and some prices
      await fetchSuppliesIfNeeded();
      if (!suppliesGlobal || Object.keys(suppliesGlobal).length === 0) {
        errEl.textContent = "Supplies data unavailable.";
        return;
      }
      if (!pricesRowsGlobal || pricesRowsGlobal.length === 0) {
        errEl.textContent = "Token prices not loaded yet.";
        return;
      }

      // Current market caps (for display)
      let mcX = 0, mcY = 0;
      for (const t of setX) mcX += getLiveMC(t);
      for (const t of setY) mcY += getLiveMC(t);
      const totMC = mcX + mcY;
      let domNow = null;
      if (totMC > 0) domNow = 100 * mcX / totMC;

      // Historical dominance range using Binance daily closes + supplies
      try {
        const unionTokens = [...new Set([...setX, ...setY])];
        // fetch histories if needed
        for (const t of unionTokens) {
          await ensurePriceHistory(t);
        }

        const dateSet = new Set();
        unionTokens.forEach(t => {
          const hist = oracleHistories[t] || {};
          Object.keys(hist).forEach(d => dateSet.add(d));
        });

        const dates = Array.from(dateSet).sort();
        const domSeries = [];

        for (const d of dates) {
          let mcX_d = 0;
          let mcY_d = 0;

          for (const t of setX) {
            const price = oracleHistories[t]?.[d];
            if (!price) { mcX_d = 0; break; }
            const s = getSupply(t);
            if (!s) { mcX_d = 0; break; }
            mcX_d += price * s;
          }

          for (const t of setY) {
            const price = oracleHistories[t]?.[d];
            if (!price) { mcY_d = 0; break; }
            const s = getSupply(t);
            if (!s) { mcY_d = 0; break; }
            mcY_d += price * s;
          }

          const total = mcX_d + mcY_d;
          if (mcX_d > 0 && mcY_d > 0 && total > 0) {
            domSeries.push(100 * mcX_d / total);
          }
        }

        let rangeText = "–";
        if (domSeries.length > 0) {
          const mn = Math.min(...domSeries);
          const mx = Math.max(...domSeries);
          rangeText = `${Math.round(mn)}–${Math.round(mx)}%`;
        } else {
          rangeText = "N/A";
        }

        // Label like "SOL vs ETHBNB" etc.
        const labelX = setX.join("");
        const labelY = setY.join("");
        const domFmt = domNow === null ? "--" : domNow.toFixed(1);

        mainEl.innerHTML =
          `<span class="dom-value">${domFmt}</span>` +
          `<span class="dom-label">${labelX} vs ${labelY}</span>`;
        subEl.innerHTML =
          `Market caps: <span>${formatMC(mcX)} vs ${formatMC(mcY)}</span>`;
        rangeEl.innerHTML =
          `Range: <span>${rangeText}</span>`;
      } catch (err) {
        console.error("Oracle dominance error:", err);
        errEl.textContent = "Error computing dominance range.";
        mainEl.innerHTML =
          `<span class="dom-value">--</span><span class="dom-label">Error</span>`;
        subEl.innerHTML = `Market caps: <span>–</span>`;
        rangeEl.innerHTML = `Range: <span>–</span>`;
      }
    }

    (function init() {
      fetchHMI();
      fetchDominance();
      fetchPrices();

      setInterval(fetchHMI, 60 * 1000);               // 60s polling of HMI JSON
      setInterval(fetchDominance, 6 * 60 * 60 * 1000); // 6h polling of Dom JSON
      // Prices only refresh on page load as requested
    })();
  </script>
</body>
</html>
