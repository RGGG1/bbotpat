<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HiveAI - All signal, no noise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <style>
    :root {
      --bg: #000000;
      --panel: #0b0d10;
      --panel2: #0a0b0d;
      --border: rgba(255, 255, 255, 0.08);
      --border2: rgba(255, 255, 255, 0.12);

      --text: #f5f5f7;
      --muted: #8c90a3;

      /* Binance-ish yellow */
      --yellow: #f0b90b;
      --yellow-soft: rgba(240, 185, 11, 0.18);

      --green: #16c784;
      --red: #ea3943;

      --font: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 22px 14px;
    }

    .shell {
      width: 100%;
      max-width: 1120px;
    }

    /* Header */
    header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 10px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 240px;
    }

    .brand-title {
      display: inline-flex;
      align-items: baseline;
      gap: 10px;
      font-weight: 650;
      letter-spacing: 0.04em;
      text-transform: none;
      font-size: 22px;
      line-height: 1.1;
    }

    .brand-title .hive {
      color: var(--yellow);
    }

    .brand-tagline {
      font-size: 12px;
      color: var(--muted);
      font-style: italic;
      letter-spacing: 0.02em;
    }

    .meta {
      text-align: right;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      padding-top: 2px;
    }

    .meta a {
      text-decoration: none;
      font-size: 10px;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: var(--muted);
      white-space: nowrap;
    }

    .meta a:hover { color: var(--yellow); }

    /* Sections */
    main {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .section {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 14px 14px;
      box-shadow: 0 16px 50px rgba(0,0,0,0.55);
    }

    .section-title {
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-weight: 600;
      color: var(--yellow);
      margin-bottom: 10px;
    }

    /* HMI block */
    .hmi-wrap {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .hmi-topline {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: end;
    }

    .hmi-score {
      text-align: right;
      font-weight: 800;
      font-size: 68px;
      line-height: 0.95;
      letter-spacing: 0.01em;
    }

    /* ===== NEW HMI GRAPHIC (exponential bar chart, red->orange->yellow fill, grey remainder) ===== */
    .hmi-bars-wrap {
      display: flex;
      align-items: flex-end;
      gap: 0;
      height: 54px;
      border-radius: 10px;
      padding: 8px 10px 6px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.08);
      overflow: hidden;
      position: relative;
    }

    .hmi-bars {
      display: grid;
      grid-template-columns: repeat(24, 1fr);
      gap: 6px;
      align-items: end;
      width: 100%;
      height: 100%;
    }

    .hmi-barcol {
      width: 100%;
      border-radius: 6px 6px 4px 4px;
      background: #2a2c31; /* inactive grey */
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
      transition: background 220ms ease, opacity 220ms ease, transform 220ms ease;
    }

    .hmi-barcol.active {
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35), 0 8px 18px rgba(0,0,0,0.35);
    }

    /* subtle “trend” feel */
    .hmi-barcol.active { transform: translateY(-0.5px); }
    /* ===== END NEW HMI GRAPHIC ===== */

    .hmi-status {
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-top: 2px;
    }

    .hmi-legend {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .hmi-legend span:nth-child(1) { text-align: left; }
    .hmi-legend span:nth-child(2) { text-align: center; }
    .hmi-legend span:nth-child(3) { text-align: right; }

    .hmi-tracking {
      display: inline-flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted);
    }

    .dot {
      width: 6px; height: 6px;
      border-radius: 999px;
      background: var(--yellow);
      box-shadow: 0 0 10px rgba(240,185,11,0.35);
      display: inline-block;
      margin-right: 6px;
      transform: translateY(-1px);
    }

    /* ACTION */
    .action-line {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .action-title {
      color: var(--yellow);
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-weight: 650;
    }

    .action-kind {
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-weight: 650;
      color: var(--yellow);
    }

    .action-token {
      text-align: center;
      font-size: 72px;
      line-height: 0.95;
      font-weight: 850;
      letter-spacing: 0.01em;
      color: var(--yellow);
      margin-top: 2px;
    }

    .action-sub {
      text-align: center;
      font-size: 14px;
      color: var(--text);
      margin-top: 8px;
      opacity: 0.95;
    }

    .divider {
      height: 1px;
      background: rgba(255,255,255,0.08);
      margin: 14px 0;
    }

    /* Agents table */
    .agents-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2px;
      font-size: 13px;
    }

    .agents-table thead th {
      text-align: left;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-weight: 650;
      color: var(--muted);
      padding: 8px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .agents-table tbody td {
      padding: 10px 6px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .agents-table tbody tr:last-child td { border-bottom: none; }

    .right { text-align: right; }
    .center { text-align: center; }

    /* Dominance section (reuse v1 dropdown logic but v2-ish styling) */
    .oracle-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .oracle-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
      margin-left: auto;
    }

    .oracle-pill-wrapper { position: relative; }

    .oracle-pill {
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      min-width: 110px;
      font-size: 12px;
      color: var(--text);
    }

    .oracle-pill-label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .oracle-pill-arrow {
      font-size: 10px;
      opacity: 0.85;
      color: var(--muted);
    }

    .oracle-vs {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.10em;
      color: var(--muted);
    }

    .oracle-dropdown {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      z-index: 20;
      background: #050608;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 14px 50px rgba(0,0,0,0.75);
      padding: 6px 6px 6px;
      min-width: 180px;
      max-height: 280px;
      overflow-y: auto;
      display: none;
    }

    .oracle-dropdown.open { display: block; }

    .oracle-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      color: var(--muted);
    }

    .oracle-option:hover { background: rgba(255,255,255,0.06); }

    .oracle-option.selected { color: var(--yellow); }

    .oracle-option-box {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.18);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--yellow);
    }

    .oracle-option.selected .oracle-option-box {
      background: rgba(240,185,11,0.10);
      border-color: rgba(240,185,11,0.35);
    }

    .oracle-option-tick { display: none; }
    .oracle-option.selected .oracle-option-tick { display: block; }

    .oracle-clear {
      margin-top: 6px;
      padding: 6px 8px;
      text-align: right;
      font-size: 10px;
      color: var(--muted);
      border-top: 1px solid rgba(255,255,255,0.10);
      cursor: pointer;
    }

    .oracle-clear:hover { color: var(--yellow); }

    .oracle-main-line {
      font-size: 16px;
      font-weight: 650;
      margin-bottom: 6px;
    }

    .oracle-main-line .dom-value {
      font-size: 38px;
      font-weight: 850;
      margin-right: 8px;
      color: var(--text);
    }

    .oracle-main-line .dom-label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }

    .oracle-sub-line,
    .oracle-range-line {
      font-size: 13px;
      color: var(--muted);
      margin-top: 3px;
    }

    .oracle-sub-line span,
    .oracle-range-line span { color: var(--text); }

    .oracle-error {
      font-size: 12px;
      color: var(--red);
      margin-top: 6px;
    }

    /* Tokens table */
    .prices-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12.5px;
      margin-top: 8px;
    }

    .prices-table thead {
      border-bottom: 1px solid rgba(255,255,255,0.10);
    }

    .prices-table th,
    .prices-table td { padding: 10px 6px; }

    .prices-table th {
      font-weight: 650;
      text-transform: uppercase;
      letter-spacing: 0.10em;
      font-size: 10px;
      color: var(--muted);
    }

    .prices-table th.token-col,
    .prices-table td.token-col { text-align: left; }

    .prices-table th.center,
    .prices-table td.center { text-align: center; }

    .prices-table tbody tr { border-bottom: 1px solid rgba(255,255,255,0.06); }
    .prices-table tbody tr:last-child { border-bottom: none; }

    @media (max-width: 700px) {
      body { padding: 14px 10px; }
      .hmi-score { font-size: 64px; }
      .action-token { font-size: 64px; }
      header { margin-bottom: 8px; }
      .hmi-bars-wrap { height: 50px; }
      .hmi-bars { gap: 5px; }
    }
  </style>
</head>

<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="brand-title">
          <span class="hive">HiveAI</span>
        </div>
        <div class="brand-tagline">All signal, no noise</div>
      </div>

      <div class="meta">
        <div>Updated: <span id="meta-date">--/--/-- --:--</span></div>
        <a href="/oracle.html">HiveAI Oracle →</a>
      </div>
    </header>

    <main>
      <!-- HMI -->
      <section class="section" id="hmi-section">
        <div class="section-title">Hive Mind Index</div>

        <div class="hmi-wrap">
          <div class="hmi-topline">
            <div>
              <!-- NEW HMI BAR CHART -->
              <div class="hmi-bars-wrap" aria-hidden="true">
                <div class="hmi-bars" id="hmi-bars"></div>
              </div>

              <div class="hmi-tracking" style="margin-top:10px;">
                <span><span class="dot"></span>Open interest</span>
                <span><span class="dot"></span>Perps vs spot</span>
                <span><span class="dot"></span>Volatility</span>
              </div>
            </div>

            <div class="hmi-score" id="hmi-value">--</div>
          </div>

          <div class="hmi-status" id="hmi-status">–</div>

          <div class="hmi-legend">
            <span>Fear</span>
            <span>Neutral</span>
            <span>Greed</span>
          </div>
        </div>
      </section>

      <!-- ACTION -->
      <section class="section" id="action-section">
        <div class="action-line">
          <div class="action-title" id="action-title">ACTION</div>
          <div class="action-kind" id="action-kind">BUY</div>
        </div>

        <div class="action-token" id="action-token">$--</div>
        <div class="action-sub" id="action-sub">Entry: -- | Target: --</div>
      </section>

      <!-- AGENTS -->
      <section class="section" id="agents-section">
        <div class="section-title">Agents</div>
        <table class="agents-table">
          <thead>
            <tr>
              <th>Name</th>
              <th class="right">Balance</th>
              <th class="right">ROI</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>BTC buy and hold</td>
              <td class="right" id="agent-btc-balance">$--</td>
              <td class="right" id="agent-btc-roi">--%</td>
            </tr>
            <tr>
              <td>Index Rebalancer</td>
              <td class="right" id="agent-kc1-balance">$--</td>
              <td class="right" id="agent-kc1-roi">--%</td>
            </tr>
            <tr>
              <td>Knifecatcher</td>
              <td class="right" id="agent-kc2-balance">$--</td>
              <td class="right" id="agent-kc2-roi">--%</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- DOMINANCE -->
      <section class="section" id="dom-section">
        <div class="oracle-header-row">
          <div class="section-title" style="margin:0;">Dominance</div>

          <div class="oracle-header-right">
            <div class="oracle-pill-wrapper">
              <div class="oracle-pill" id="oracle-x-pill">
                <span class="oracle-pill-label" id="oracle-x-label">Select</span>
                <span class="oracle-pill-arrow">▾</span>
              </div>
              <div class="oracle-dropdown" id="oracle-x-menu"></div>
            </div>

            <span class="oracle-vs">vs</span>

            <div class="oracle-pill-wrapper">
              <div class="oracle-pill" id="oracle-y-pill">
                <span class="oracle-pill-label" id="oracle-y-label">Select</span>
                <span class="oracle-pill-arrow">▾</span>
              </div>
              <div class="oracle-dropdown" id="oracle-y-menu"></div>
            </div>
          </div>
        </div>

        <div class="oracle-main-line" id="oracle-main-line">
          <span class="dom-value">--</span>
          <span class="dom-label">Select X and Y</span>
        </div>

        <div class="oracle-sub-line" id="oracle-sub-line">
          Market caps: <span>–</span>
        </div>

        <div class="oracle-range-line" id="oracle-range-line">
          Range: <span>–</span>
        </div>

        <div class="oracle-error" id="oracle-error"></div>
      </section>

      <!-- TOKENS -->
      <section class="section" id="tokens-section">
        <div class="section-title">Tokens</div>
        <table class="prices-table">
          <thead>
            <tr>
              <th class="token-col">Token</th>
              <th class="center">Price</th>
              <th class="center">Dom</th>
              <th class="center">Range</th>
              <th class="center">Action</th>
              <th class="center">Pot. ROI</th>
            </tr>
          </thead>
          <tbody id="prices-tbody"></tbody>
        </table>
      </section>
    </main>
  </div>

  <script>
    const HMI_NEUTRAL_LOW = 40;
    const HMI_NEUTRAL_HIGH = 60;

    const ORACLE_TOKENS = ["BTC","ETH","BNB","SOL","DOGE","TON","SUI","UNI"];

    let pricesRowsGlobal = [];
    let suppliesGlobal = null;
    let oracleHistories = {};
    let domBandsGlobal = null;

    let oracleSelectedX = ["BTC"];   // default
    let oracleSelectedY = ["ALTS"];  // default: all alts (not BTC)

    function formatDateTime(ts) {
      if (!ts) return "--/--/-- --:--";
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yy = String(d.getFullYear()).slice(-2);
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${dd}/${mm}/${yy} ${hh}:${mi}`;
    }

    function formatMC(v) {
      if (!v || v <= 0) return "$0";
      if (v >= 1e12) return `$${(v / 1e12).toFixed(1)}T`;
      if (v >= 1e9) return `$${Math.round(v / 1e9)}B`;
      if (v >= 1e6) return `$${Math.round(v / 1e6)}M`;
      return `$${Math.round(v).toLocaleString()}`;
    }

    function clamp01(x) { return Math.max(0, Math.min(1, x)); }

    function hmiBandLabel(hmi) {
      if (hmi < 10) return "Zombie Apocalypse";
      if (hmi < 25) return "McDonald's Applications in high demand";
      if (hmi < 45) return "NGMI";
      if (hmi < 50) return "Leaning bearish";
      if (hmi < 55) return "Cautiously bullish";
      if (hmi < 75) return "It's digital gold";
      if (hmi < 90) return "Frothy";
      return "It's the future of finance";
    }

    /* ===== NEW HMI RENDERER: exponential bars, fill to score, red->orange->yellow; remainder grey ===== */
    function lerp(a, b, t) { return a + (b - a) * t; }
    function lerpColor(c1, c2, t) {
      return {
        r: Math.round(lerp(c1.r, c2.r, t)),
        g: Math.round(lerp(c1.g, c2.g, t)),
        b: Math.round(lerp(c1.b, c2.b, t)),
      };
    }
    function rgbToCss(c) { return `rgb(${c.r}, ${c.g}, ${c.b})`; }

    function gradientRedOrangeYellow(t) {
      // 0..1 mapped into two segments:
      // deep red (#6b0f0f) -> orange (#d55a14) -> bright yellow (#f0b90b)
      const red = { r: 107, g: 15, b: 15 };
      const orange = { r: 213, g: 90, b: 20 };
      const yellow = { r: 240, g: 185, b: 11 };

      if (t <= 0.55) {
        const tt = t / 0.55;
        return lerpColor(red, orange, tt);
      } else {
        const tt = (t - 0.55) / 0.45;
        return lerpColor(orange, yellow, tt);
      }
    }

    function renderHmiBars(hmi) {
      const barsEl = document.getElementById("hmi-bars");
      if (!barsEl) return;

      const N = 24;
      const fillCount = Math.round(clamp01(hmi / 100) * N);

      // exponential profile B/C style (more steep near the end)
      const exp = 2.25; // “B and C exponential” feel

      // build once per update (simple + robust)
      barsEl.innerHTML = "";

      for (let i = 1; i <= N; i++) {
        const col = document.createElement("div");
        col.className = "hmi-barcol";

        const x = i / N; // 0..1
        const h = Math.max(0.08, Math.pow(x, exp)); // 0.08..1
        col.style.height = (h * 100).toFixed(2) + "%";

        if (i <= fillCount) {
          col.classList.add("active");
          const c = gradientRedOrangeYellow(x);
          col.style.background = rgbToCss(c);
          col.style.opacity = "1";
        } else {
          col.style.background = "#2a2c31";
          col.style.opacity = "0.9";
        }

        barsEl.appendChild(col);
      }
    }
    /* ===== END NEW HMI RENDERER ===== */

    async function fetchHMI() {
      try {
        const resp = await fetch("/hmi_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("HMI fetch failed");
        const data = await resp.json();

        const hmiRaw = (typeof data.hmi === "number") ? data.hmi : parseFloat(data.hmi);
        const hmi = Number.isNaN(hmiRaw) ? null : hmiRaw;
        if (hmi === null) throw new Error("Invalid HMI");

        const hmiEl = document.getElementById("hmi-value");
        const statusEl = document.getElementById("hmi-status");

        if (hmiEl) hmiEl.textContent = Math.round(hmi).toString();
        if (statusEl) statusEl.textContent = hmiBandLabel(hmi);

        // NEW: render exponential bars filled to score
        renderHmiBars(hmi);
      } catch (err) {
        console.error("HMI error:", err);
      }
    }

    async function fetchSupplies() {
      try {
        const resp = await fetch("/supplies_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("supplies fetch failed");
        const data = await resp.json();
        suppliesGlobal = data && data.supplies ? data.supplies : null;
      } catch (err) {
        console.error("Supplies error:", err);
        suppliesGlobal = null;
      }
    }

    async function fetchOracleHistory() {
      try {
        const resp = await fetch("/dom_history_latest.json", { cache: "no-store" });
        if (!resp.ok) {
          oracleHistories = {};
          return;
        }
        const data = await resp.json();
        oracleHistories = data && data.series ? data.series : {};
      } catch (err) {
        console.error("Oracle history error:", err);
        oracleHistories = {};
      }
    }

    async function fetchDomBands() {
      try {
        const resp = await fetch("/dom_bands_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("dom bands fetch failed");
        domBandsGlobal = await resp.json();
      } catch (err) {
        console.error("Dom bands error:", err);
        domBandsGlobal = null;
      }
    }

    // ---- Potential ROI helpers ----

    function parseRangeToLowHigh(rangeStr) {
      if (!rangeStr) return null;
      const m = String(rangeStr).match(/(\d+(?:\.\d+)?)\D+(\d+(?:\.\d+)?)/);
      if (!m) return null;
      const low = parseFloat(m[1]);
      const high = parseFloat(m[2]);
      if (!(high > low)) return null;
      return { low, high };
    }

    function computeNeutralHigh(low, high) {
      const width = high - low;
      return low + 0.60 * width;
    }

    function computePotentialRoi(row, btcMcRaw) {
      const token = (row.token || "").toUpperCase();
      if (!token || token === "BTC" || token.includes("USD")) return null;

      const rangeInfo = parseRangeToLowHigh(row.range || "");
      if (!rangeInfo) return null;
      const { low, high } = rangeInfo;

      const btcMc = (typeof btcMcRaw === "number") ? btcMcRaw : parseFloat(btcMcRaw || "0");
      const altMc = (typeof row.mc === "number") ? row.mc : parseFloat(row.mc || "0");
      const priceNow = (typeof row.price === "number") ? row.price : parseFloat(row.price || "0");

      if (!(btcMc > 0 && altMc > 0 && priceNow > 0)) return null;

      const neutralHigh = computeNeutralHigh(low, high);
      const domTarget = neutralHigh / 100.0;
      if (!(domTarget > 0 && domTarget < 1)) return null;

      const sTarget = (1.0 - domTarget) / domTarget * btcMc;
      const supplyEst = altMc / priceNow;
      if (!(supplyEst > 0)) return null;

      const targetPrice = sTarget / supplyEst;
      if (!(targetPrice > 0)) return null;

      return (targetPrice / priceNow) - 1.0;
    }

    function computeActionForRow(row) {
      const token = row.token;
      if (!token) return "–";
      const upToken = String(token).toUpperCase();

      if (upToken === "BTC" || upToken.includes("USD")) return "–";

      const domRaw = (typeof row.btc_dom === "number")
        ? row.btc_dom
        : parseFloat(row.btc_dom ?? "NaN");
      if (!Number.isFinite(domRaw)) return "–";

      const rangeStr = row.range || "";
      const m = rangeStr.match(/(\d+(?:\.\d+)?)\D+(\d+(?:\.\d+)?)%?/);
      if (!m) return "–";

      const minPct = parseFloat(m[1]);
      const maxPct = parseFloat(m[2]);
      if (!Number.isFinite(minPct) || !Number.isFinite(maxPct) || maxPct <= minPct) return "–";

      let pos = (domRaw - minPct) / (maxPct - minPct);
      if (!Number.isFinite(pos)) return "–";
      pos = Math.max(0, Math.min(1, pos));

      if (pos >= 0.4 && pos <= 0.6) return "Stables";

      let altPct, btcPct;
      if (pos < 0.4) {
        const t = pos / 0.4;
        btcPct = 100 - Math.round(t * 50);
        altPct = 100 - btcPct;
      } else {
        const t = (pos - 0.6) / 0.4;
        altPct = 50 + Math.round(t * 50);
        btcPct = 100 - altPct;
      }

      altPct = Math.max(0, Math.min(100, Math.round(altPct)));
      btcPct = 100 - altPct;
      return `${altPct}/${btcPct}`;
    }

    function formatRangeTwoDecimals(rangeStr) {
      if (!rangeStr) return "–";
      const m = String(rangeStr).match(/(\d+(?:\.\d+)?)[^\d]+(\d+(?:\.\d+)?)/);
      if (!m) return rangeStr;
      const low = parseFloat(m[1]);
      const high = parseFloat(m[2]);
      return low.toFixed(2) + "% – " + high.toFixed(2) + "%";
    }

    async function fetchPrices() {
      try {
        const resp = await fetch("/prices_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("prices fetch failed");
        const data = await resp.json();

        const metaEl = document.getElementById("meta-date");
        if (metaEl && data && data.timestamp) metaEl.textContent = formatDateTime(data.timestamp);

        const tbody = document.getElementById("prices-tbody");
        tbody.innerHTML = "";

        const rows = Array.isArray(data.rows) ? data.rows : [];
        pricesRowsGlobal = rows;

        let btcMc = 0;
        for (const r of rows) {
          const tok = (r.token || "").toUpperCase();
          if (tok === "BTC") {
            const v = (typeof r.mc === "number") ? r.mc : parseFloat(r.mc || "0");
            if (!Number.isNaN(v) && v > 0) btcMc = v;
            break;
          }
        }

        rows.forEach(row => {
          const tr = document.createElement("tr");

          const tdToken = document.createElement("td");
          tdToken.className = "token-col";
          tdToken.textContent = row.token || "";
          tr.appendChild(tdToken);

          const tdPrice = document.createElement("td");
          tdPrice.className = "center";
          const priceVal = typeof row.price === "number" ? row.price : parseFloat(row.price || "0");
          if (!Number.isNaN(priceVal) && priceVal > 0) {
            if (priceVal >= 1000) tdPrice.textContent = "$" + Math.round(priceVal).toLocaleString();
            else if (priceVal >= 1) tdPrice.textContent = "$" + priceVal.toFixed(2);
            else if (priceVal >= 0.01) tdPrice.textContent = "$" + priceVal.toFixed(3);
            else tdPrice.textContent = "$" + priceVal.toFixed(6);
          } else tdPrice.textContent = "–";
          tr.appendChild(tdPrice);

          const tdDom = document.createElement("td");
          tdDom.className = "center";
          const dom = (typeof row.btc_dom === "number") ? row.btc_dom : parseFloat(row.btc_dom ?? "NaN");
          tdDom.textContent = Number.isFinite(dom) ? dom.toFixed(1) + "%" : "–";
          tr.appendChild(tdDom);

          const tdRange = document.createElement("td");
          tdRange.className = "center";
          tdRange.textContent = formatRangeTwoDecimals(row.range);
          tr.appendChild(tdRange);

          const tdAction = document.createElement("td");
          tdAction.className = "center";
          tdAction.textContent = computeActionForRow(row);
          tr.appendChild(tdAction);

          const tdRoi = document.createElement("td");
          tdRoi.className = "center";
          const roiFrac = computePotentialRoi(row, btcMc);
          if (roiFrac == null || Number.isNaN(roiFrac)) tdRoi.textContent = "–";
          else {
            const pct = roiFrac * 100;
            const sign = pct > 0 ? "+" : "";
            tdRoi.textContent = sign + pct.toFixed(1) + "%";
          }
          tr.appendChild(tdRoi);

          tbody.appendChild(tr);
        });

        buildOracleMenus();
        updateOracle();
      } catch (err) {
        console.error("Prices error:", err);
      }
    }

    async function fetchAgentsAndAction() {
      // KC1 + BTC buy & hold from knifecatcher_latest.json
      // KC2 + recommended trade from dom_signals_hourly.json
      try {
        const resp = await fetch("/knifecatcher_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("knifecatcher fetch failed");
        const data = await resp.json();

        const base = typeof data.base_balance_usd === "number" ? data.base_balance_usd : parseFloat(data.base_balance_usd || "0");
        const portVal = typeof data.portfolio_value === "number" ? data.portfolio_value : parseFloat(data.portfolio_value || "0");
        const btcVal = typeof data.btc_value === "number" ? data.btc_value : parseFloat(data.btc_value || "0");

        const kc1BalEl = document.getElementById("agent-kc1-balance");
        const kc1RoiEl = document.getElementById("agent-kc1-roi");
        const btcBalEl = document.getElementById("agent-btc-balance");
        const btcRoiEl = document.getElementById("agent-btc-roi");

        function fmtUsd(x) { return (Number.isFinite(x) ? "$" + x.toFixed(2) : "$--"); }
        function fmtPct(x) {
          if (!Number.isFinite(x)) return "--%";
          const pct = x * 100;
          const sign = pct > 0 ? "+" : "";
          return sign + pct.toFixed(1) + "%";
        }

        if (Number.isFinite(portVal) && kc1BalEl) kc1BalEl.textContent = fmtUsd(portVal);
        if (base > 0 && kc1RoiEl) kc1RoiEl.textContent = fmtPct((portVal / base) - 1);

        if (base > 0 && btcRoiEl) btcRoiEl.textContent = fmtPct((btcVal / base) - 1);
        // “Assume $100 originally” request: show BTC buy&hold balance as 100*(1+roi)
        if (base > 0 && btcBalEl) {
          const roi = (btcVal / base) - 1;
          btcBalEl.textContent = fmtUsd(100 * (1 + roi));
        }
        // Similarly, KC1 balance as $100*(1+roi)
        if (base > 0 && kc1BalEl) {
          const roi = (portVal / base) - 1;
          kc1BalEl.textContent = fmtUsd(100 * (1 + roi));
        }
      } catch (e) {
        console.error("KC1/BTC agents error:", e);
      }

      try {
        const resp2 = await fetch("/dom_signals_hourly.json", { cache: "no-store" });
        if (!resp2.ok) throw new Error("dom_signals fetch failed");
        const sig = await resp2.json();

        const kc2BalEl = document.getElementById("agent-kc2-balance");
        const kc2RoiEl = document.getElementById("agent-kc2-roi");

        const actionKindEl = document.getElementById("action-kind");
        const actionTokenEl = document.getElementById("action-token");
        const actionSubEl = document.getElementById("action-sub");

        function fmtUsd(x) { return (Number.isFinite(x) ? "$" + x.toFixed(2) : "$--"); }
        function fmtPct(x) {
          if (!Number.isFinite(x)) return "--%";
          const pct = x * 100;
          const sign = pct > 0 ? "+" : "";
          return sign + pct.toFixed(1) + "%";
        }

        const equityUsd = (typeof sig.equity_usd === "number") ? sig.equity_usd : parseFloat(sig.equity_usd || "NaN");
        const roiFrac = (typeof sig.roi_frac === "number") ? sig.roi_frac : parseFloat(sig.roi_frac || "NaN");

        if (kc2BalEl && Number.isFinite(equityUsd)) {
          // “Assume $100 originally”: use ROI to compute balance
          if (Number.isFinite(roiFrac)) kc2BalEl.textContent = fmtUsd(100 * (1 + roiFrac));
          else kc2BalEl.textContent = fmtUsd(equityUsd);
        }
        if (kc2RoiEl) kc2RoiEl.textContent = fmtPct(roiFrac);

        // Action box from KC2 position (always “A always green” per your latest instruction set)
        const pos = sig && sig.position ? sig.position : null;
        if (!pos) return;

        const token = (pos.token || "STABLES").toString().toUpperCase();
        const entry = (typeof pos.entry_price === "number") ? pos.entry_price : parseFloat(pos.entry_price || "NaN");
        const target = (typeof pos.target_price === "number") ? pos.target_price : parseFloat(pos.target_price || "NaN");

        // If in stables, show STABLES; otherwise show token.
        if (actionKindEl) actionKindEl.textContent = "BUY";
        if (actionTokenEl) actionTokenEl.textContent = token === "NONE" ? "STABLES" : "$" + token;

        let sub = "Entry: -- | Target: --";
        if (Number.isFinite(entry) && Number.isFinite(target)) {
          sub = `Entry: $${entry.toFixed(2)} | Target: $${target.toFixed(2)}`;
        }
        if (actionSubEl) actionSubEl.textContent = sub;
      } catch (e2) {
        console.error("KC2/action error:", e2);
      }
    }

    // -------- Oracle helpers --------
    function formatTokenLabel(token) {
      if (token === "ALTS") return "Alts";
      const lower = token.toLowerCase();
      return lower.charAt(0).toUpperCase() + lower.slice(1);
    }

    function formatTokenSetLabel(tokens) {
      if (tokens.length === 0) return "Select";
      if (tokens.includes("ALTS")) return "Alts";
      if (tokens.length === 1) return formatTokenLabel(tokens[0]);
      return tokens.map(formatTokenLabel).join("");
    }

    function getLiveMC(token) {
      const row = pricesRowsGlobal.find(r => r.token === token);
      if (!row) return 0;
      const v = row.mc;
      if (typeof v === "number") return v;
      const f = parseFloat(v || "0");
      return Number.isNaN(f) ? 0 : f;
    }

    function getHistorySeries(key) {
      if (!oracleHistories) return null;
      return oracleHistories[key] || null;
    }

    function sortTokensByMC(tokens) {
      const arr = [...tokens];
      arr.sort((a, b) => {
        const aMC = getLiveMC(a);
        const bMC = getLiveMC(b);
        if (aMC > bMC) return -1;
        if (aMC < bMC) return 1;
        return a.localeCompare(b);
      });
      return arr;
    }

    function computeOracleDomAndRange(xTokens, yTokens) {
      if (!Array.isArray(xTokens) || !Array.isArray(yTokens)) return { ok: false, reason: "Missing selections" };
      if (xTokens.length === 0 || yTokens.length === 0) return { ok: false, reason: "Select both sides" };

      const expandSide = (tokens) => tokens.includes("ALTS") ? ORACLE_TOKENS.filter(t => t !== "BTC") : tokens;
      const xSet = expandSide(xTokens);
      const ySet = expandSide(yTokens);

      const fullX = new Set(xSet);
      const fullY = new Set(ySet);

      if (fullX.size === 0 || fullY.size === 0) return { ok: false, reason: "Both sides need tokens" };

      const mcX = Array.from(fullX).reduce((acc, t) => acc + getLiveMC(t), 0);
      const mcY = Array.from(fullY).reduce((acc, t) => acc + getLiveMC(t), 0);
      const totalNow = mcX + mcY;
      if (totalNow <= 0) return { ok: false, reason: "No market cap data" };

      const domNow = (mcX / totalNow) * 100;

      const key = `${Array.from(fullX).sort().join("+")}__${Array.from(fullY).sort().join("+")}`;
      const hist = getHistorySeries(key);
      let domMin = null, domMax = null, days = 0;

      if (hist && Array.isArray(hist.values) && hist.values.length > 0) {
        days = hist.values.length;
        domMin = Math.min(...hist.values);
        domMax = Math.max(...hist.values);
      } else {
        const xIsBTCOnly = (xTokens.length === 1 && xTokens[0] === "BTC");
        const yIsAltsOnly = (yTokens.length === 1 && yTokens[0] === "ALTS");
        if (xIsBTCOnly && yIsAltsOnly && domBandsGlobal) {
          const mn = parseFloat(domBandsGlobal.min_pct);
          const mx = parseFloat(domBandsGlobal.max_pct);
          if (!Number.isNaN(mn) && !Number.isNaN(mx)) {
            domMin = mn; domMax = mx; days = domBandsGlobal.days || 0;
          }
        }
      }

      const prettyName = (tokens) => {
        if (tokens.includes("ALTS")) return "Alts";
        const sorted = sortTokensByMC(tokens);
        return sorted.map(formatTokenLabel).join("");
      };

      return {
        ok: true,
        domNow,
        domMin,
        domMax,
        days,
        mcX,
        mcY,
        labelX: prettyName(xTokens),
        labelY: prettyName(yTokens),
      };
    }

    function buildOracleMenus() {
      const xMenu = document.getElementById("oracle-x-menu");
      const yMenu = document.getElementById("oracle-y-menu");
      const xLabel = document.getElementById("oracle-x-label");
      const yLabel = document.getElementById("oracle-y-label");
      const xPill = document.getElementById("oracle-x-pill");
      const yPill = document.getElementById("oracle-y-pill");

      if (!xMenu || !yMenu || !xLabel || !yLabel || !xPill || !yPill) return;

      const xOrder = ["BTC", ...ORACLE_TOKENS.filter(t => t !== "BTC")];
      const yOrder = ["ALTS", "BTC", ...ORACLE_TOKENS.filter(t => t !== "BTC")];

      const xIsPureBTC = (oracleSelectedX.length === 1 && oracleSelectedX[0] === "BTC");

      xMenu.innerHTML = "";
      yMenu.innerHTML = "";

      xOrder.forEach(tok => {
        const div = document.createElement("div");
        div.className = "oracle-option";
        div.dataset.token = tok;

        const box = document.createElement("div");
        box.className = "oracle-option-box";

        const tick = document.createElement("span");
        tick.className = "oracle-option-tick";
        tick.textContent = "✓";

        const label = document.createElement("span");
        label.className = "oracle-option-label";
        label.textContent = formatTokenLabel(tok);

        box.appendChild(tick);
        div.appendChild(box);
        div.appendChild(label);

        if (oracleSelectedX.includes(tok)) div.classList.add("selected");

        div.addEventListener("click", (e) => {
          e.stopPropagation();
          if (tok === "BTC") {
            oracleSelectedX = oracleSelectedX.includes("BTC") ? oracleSelectedX.filter(t => t !== "BTC") : ["BTC"];
          } else {
            oracleSelectedX = oracleSelectedX.filter(t => t !== "BTC");
            oracleSelectedX = oracleSelectedX.includes(tok) ? oracleSelectedX.filter(t => t !== tok) : [...oracleSelectedX, tok];
          }
          xLabel.textContent = formatTokenSetLabel(oracleSelectedX);
          buildOracleMenus();
          updateOracle();
        });

        xMenu.appendChild(div);
      });

      const xClear = document.createElement("div");
      xClear.className = "oracle-clear";
      xClear.textContent = "Clear";
      xClear.addEventListener("click", (e) => {
        e.stopPropagation();
        oracleSelectedX = [];
        xLabel.textContent = "Select";
        buildOracleMenus();
        updateOracle();
      });
      xMenu.appendChild(xClear);

      yOrder.forEach(tok => {
        if (tok === "ALTS" && !xIsPureBTC) return;

        const div = document.createElement("div");
        div.className = "oracle-option";
        div.dataset.token = tok;

        const box = document.createElement("div");
        box.className = "oracle-option-box";

        const tick = document.createElement("span");
        tick.className = "oracle-option-tick";
        tick.textContent = "✓";

        const label = document.createElement("span");
        label.className = "oracle-option-label";
        label.textContent = formatTokenLabel(tok);

        box.appendChild(tick);
        div.appendChild(box);
        div.appendChild(label);

        if (oracleSelectedY.includes(tok)) div.classList.add("selected");

        div.addEventListener("click", (e) => {
          e.stopPropagation();
          if (tok === "ALTS") {
            oracleSelectedY = ["ALTS"];
          } else {
            oracleSelectedY = oracleSelectedY.filter(t => t !== "ALTS");
            oracleSelectedY = oracleSelectedY.includes(tok) ? oracleSelectedY.filter(t => t !== tok) : [...oracleSelectedY, tok];
          }
          yLabel.textContent = formatTokenSetLabel(oracleSelectedY);
          buildOracleMenus();
          updateOracle();
        });

        yMenu.appendChild(div);
      });

      const yClear = document.createElement("div");
      yClear.className = "oracle-clear";
      yClear.textContent = "Clear";
      yClear.addEventListener("click", (e) => {
        e.stopPropagation();
        oracleSelectedY = [];
        yLabel.textContent = "Select";
        buildOracleMenus();
        updateOracle();
      });
      yMenu.appendChild(yClear);

      xLabel.textContent = formatTokenSetLabel(oracleSelectedX);
      yLabel.textContent = formatTokenSetLabel(oracleSelectedY);

      function closeAll() {
        xMenu.classList.remove("open");
        yMenu.classList.remove("open");
      }

      xPill.onclick = (e) => {
        e.stopPropagation();
        const isOpen = xMenu.classList.contains("open");
        closeAll();
        if (!isOpen) xMenu.classList.add("open");
      };
      yPill.onclick = (e) => {
        e.stopPropagation();
        const isOpen = yMenu.classList.contains("open");
        closeAll();
        if (!isOpen) yMenu.classList.add("open");
      };

      document.addEventListener("click", closeAll);
      xMenu.addEventListener("click", (e) => e.stopPropagation());
      yMenu.addEventListener("click", (e) => e.stopPropagation());
    }

    async function updateOracle() {
      const mainEl = document.getElementById("oracle-main-line");
      const subEl = document.getElementById("oracle-sub-line");
      const rangeEl = document.getElementById("oracle-range-line");
      const errEl = document.getElementById("oracle-error");

      if (!mainEl || !subEl || !rangeEl || !errEl) return;

      const res = computeOracleDomAndRange(oracleSelectedX, oracleSelectedY);
      if (!res.ok) {
        mainEl.innerHTML = '<span class="dom-value">--</span><span class="dom-label">Select X and Y</span>';
        subEl.innerHTML = 'Market caps: <span>–</span>';
        rangeEl.innerHTML = 'Range: <span>–</span>';
        errEl.textContent = res.reason || "";
        return;
      }

      errEl.textContent = "";
      const domStr = Number.isFinite(res.domNow) ? res.domNow.toFixed(1) : "--";
      mainEl.innerHTML = `<span class="dom-value">${domStr}</span><span class="dom-label">${res.labelX} vs ${res.labelY}</span>`;

      subEl.innerHTML = `Market caps: <span>${formatMC(res.mcX || 0)} vs ${formatMC(res.mcY || 0)}</span>`;

      let rangeSpan = "–";
      if (res.domMin != null && res.domMax != null && res.domMax > res.domMin) {
        rangeSpan = `${Math.round(res.domMin)}%–${Math.round(res.domMax)}%`;
      }
      rangeEl.innerHTML = `Range: <span>${rangeSpan}</span>`;
    }

    (function init() {
      fetchHMI();
      fetchSupplies()
        .then(fetchOracleHistory)
        .then(fetchDomBands)
        .then(fetchPrices)
        .then(fetchAgentsAndAction);
    })();
  </script>
</body>
</html>
