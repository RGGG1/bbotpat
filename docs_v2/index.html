<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HiveAI - All signal, no noise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <style>
    :root {
      --bg: #000000;
      --bg-elevated: #050509;
      --border-subtle: #22232f;
      --text-main: #f5f5f7;
      --text-muted: #888aa0;
      --accent-red: #ff4b5c;
      --accent-green: #4dff88;
      --accent-neutral: #ffffff;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
                   "Inter", "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text-main);
      font-family: var(--font-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1040px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .title-stack {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .logo-row {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .logo-slash {
      font-size: 24px;
      line-height: 1;
      transition: color 0.28s ease;
    }

    .logo-hive {
      transition: color 0.28s ease;
    }

    .logo-ai {
      color: var(--text-main);
      opacity: 0.9;
    }

    .logo-accent-red {
      color: var(--accent-red);
    }

    .logo-accent-green {
      color: var(--accent-green);
    }

    .logo-accent-neutral {
      color: var(--accent-neutral);
    }

    .tagline {
      font-size: 11px;
      font-style: italic;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .meta-topline {
      text-align: right;
      font-size: 11px;
      color: var(--text-muted);
    }

    .meta-oracle-link {
      margin-top: 4px;
    }

    .card-oracle-link {
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      text-decoration: none;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .card-oracle-link:hover {
      color: var(--accent-green);
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* HERO LAYOUT (HMI + ACTION + AGENTS) */

    .hero {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .hero-grid {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 2fr);
      grid-template-rows: auto auto;
      grid-template-areas:
        "hmi action"
        "hmi agents";
      gap: 16px;
    }

    @media (max-width: 720px) {
      .hero-grid {
        grid-template-columns: minmax(0, 1fr);
        grid-template-rows: auto auto auto;
        grid-template-areas:
          "hmi"
          "action"
          "agents";
      }
    }

    .section {
      padding: 12px 12px 14px;
      background: var(--bg-elevated);
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.45);
    }

    .section-title {
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-main);
      margin-bottom: 6px;
    }

    .section-muted {
      font-size: 11px;
      color: var(--text-muted);
    }

    .section--hmi {
      grid-area: hmi;
    }

    .section--action {
      grid-area: action;
    }

    .section--agents {
      grid-area: agents;
    }

    /* HMI VISUAL */

    .hmi-main {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 4px;
      margin-bottom: 6px;
    }

    .hmi-score {
      font-size: 48px;
      font-weight: 600;
      line-height: 1;
      margin-bottom: 6px;
    }

    .hmi-band {
      font-size: 14px;
      font-weight: 500;
      color: var(--accent-neutral);
      margin-bottom: 8px;
      text-align: center;
    }

    .hmi-bar-wrapper {
      width: 100%;
      max-width: 260px;
      margin: 0 auto 8px;
    }

    .hmi-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, #820000, #ff8400, #ffd000, #00c060);
      overflow: hidden;
      position: relative;
    }

    .hmi-bar-knob {
      position: absolute;
      top: 50%;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid #ffffff;
      background: #000000;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
    }

    .hmi-label-row {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .hmi-tracking {
      text-align: center;
      margin-top: 4px;
    }

    .hmi-tracking-items {
      font-size: 11px;
      color: var(--text-muted);
      display: inline-flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }

    .hmi-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-green);
      box-shadow: 0 0 6px rgba(77, 255, 136, 0.7);
    }

    /* ACTION SECTION */

    .action-header-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
    }

    .action-title-main {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .action-label {
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-main);
    }

    .action-mode {
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent-green);
    }

    .action-token {
      font-size: 36px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 4px;
      color: var(--accent-green);
    }

    .action-line {
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
    }

    /* AGENTS TABLE */

    .agents-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
    }

    .agents-table th,
    .agents-table td {
      padding: 4px 4px;
      text-align: center;
    }

    .agents-table th {
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      font-size: 10px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-subtle);
    }

    .agents-table td:first-child,
    .agents-table th:first-child {
      text-align: left;
    }

    .agents-name {
      font-size: 12px;
    }

    .agents-positive {
      color: var(--accent-green);
    }

    .agents-negative {
      color: var(--accent-red);
    }

    /* ANALYTICS LAYOUT */

    .analytics {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .analytics-top {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 16px;
    }

    /* DOMINANCE PANEL */

    .section--dominance {
      position: relative;
    }

    .oracle-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .oracle-header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
      margin-left: auto;
    }

    .oracle-pill-wrapper {
      position: relative;
    }

    .oracle-pill {
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #33334a;
      background: #080814;
      cursor: pointer;
      min-width: 96px;
      font-size: 11px;
      color: var(--text-main);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.4);
    }

    .oracle-pill-label {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .oracle-pill-arrow {
      font-size: 9px;
      opacity: 0.8;
    }

    .oracle-vs {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .oracle-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      z-index: 20;
      background: #050509;
      border-radius: 10px;
      border: 1px solid #33334a;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.7);
      padding: 6px 6px 6px;
      min-width: 160px;
      max-height: 260px;
      overflow-y: auto;
      display: none;
    }

    .oracle-dropdown.open {
      display: block;
    }

    .oracle-option {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 6px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      color: var(--text-main);
    }

    .oracle-option:hover {
      background: #121224;
    }

    .oracle-option-box {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid #44445a;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--accent-green);
    }

    .oracle-option.selected .oracle-option-box {
      background: #101f16;
      border-color: #1f9f4a;
    }

    .oracle-option-tick {
      display: none;
    }

    .oracle-option.selected .oracle-option-tick {
      display: block;
    }

    .oracle-option-label {
      white-space: nowrap;
    }

    .oracle-clear {
      margin-top: 6px;
      padding: 4px 6px;
      text-align: right;
      font-size: 10px;
      color: var(--text-muted);
      border-top: 1px solid #222238;
      cursor: pointer;
    }

    .oracle-clear:hover {
      color: var(--accent-neutral);
    }

    .oracle-main-line {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .oracle-main-line .dom-value {
      font-size: 32px;
      font-weight: 600;
      margin-right: 6px;
    }

    .oracle-main-line .dom-label {
      font-size: 13px;
      color: var(--accent-neutral);
    }

    .oracle-sub-line,
    .oracle-range-line {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .oracle-sub-line span,
    .oracle-range-line span {
      color: var(--text-main);
    }

    .oracle-error {
      font-size: 11px;
      color: var(--accent-red);
      margin-top: 4px;
    }

    .oracle-chart-placeholder {
      margin-top: 10px;
      height: 80px;
      border-radius: 8px;
      background: radial-gradient(circle at 0% 0%, #1a1b2a, #050509);
      border: 1px solid #1c1d2a;
      opacity: 0.9;
    }

    /* PRICES / TOKENS */

    .prices-card {
      padding: 10px 12px 12px;
      background: var(--bg-elevated);
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.45);
    }

    .prices-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .prices-title {
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-main);
    }

    .prices-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
    }

    .prices-table thead {
      border-bottom: 1px solid var(--border-subtle);
    }

    .prices-table th,
    .prices-table td {
      padding: 6px 4px;
    }

    .prices-table th {
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      font-size: 10px;
      color: var(--text-muted);
    }

    .prices-table th.token-col,
    .prices-table td.token-col {
      text-align: left;
    }

    .prices-table th.center,
    .prices-table td.center {
      text-align: center;
    }

    .prices-table tbody tr {
      border-bottom: 1px solid #11111a;
    }

    .prices-table tbody tr:last-child {
      border-bottom: none;
    }

    .prices-table tbody tr:nth-child(even) {
      background: #070711;
    }

    .prices-table tbody tr:nth-child(odd) {
      background: #050509;
    }

    .token-cell {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .token-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      flex-shrink: 0;
    }

    .token-dot-positive {
      background: var(--accent-green);
    }

    .token-dot-negative {
      background: var(--accent-red);
    }

    .token-dot-neutral {
      background: #ffffff;
    }

    .footer-note {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .footer-note-title {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 10px;
      margin-bottom: 2px;
    }

    .oracle-notes-card {
      margin-top: 4px;
      padding: 10px 12px 12px;
      background: var(--bg-elevated);
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.45);
    }

    @media (max-width: 700px) {
      .prices-table {
        font-size: 11px;
      }
      .prices-table th,
      .prices-table td {
        padding: 5px 3px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="title-stack">
        <div class="logo-row">
          <span id="logo-slash" class="logo-slash logo-accent-neutral">/</span>
          <span class="logo-wordmark">
            <span id="logo-hive" class="logo-hive logo-accent-neutral">HiveAI</span>
          </span>
        </div>
        <div class="tagline">All signal, no noise</div>
      </div>
      <div class="meta-topline">
        Updated: <span id="meta-date">--/--/-- --:--</span>
        <div class="meta-oracle-link">
          <a href="oracle.html" class="card-oracle-link">HiveAI Oracle →</a>
        </div>
      </div>
    </header>

    <main>
      <!-- HERO: HMI + ACTION + AGENTS -->
      <section class="hero">
        <div class="hero-grid">
          <!-- HMI -->
          <section class="section section--hmi">
            <div class="section-title">Hive Mind Index</div>
            <div class="hmi-main">
              <div id="hmi-score" class="hmi-score">--.-</div>
              <div id="hmi-status" class="hmi-band">–</div>
              <div class="hmi-bar-wrapper">
                <div class="hmi-bar">
                  <div id="hmi-bar-knob" class="hmi-bar-knob" style="left: 50%;"></div>
                </div>
                <div class="hmi-label-row">
                  <span>Fear</span>
                  <span>Neutral</span>
                  <span>Greed</span>
                </div>
              </div>
            </div>
            <div class="hmi-tracking">
              <div class="hmi-tracking-items">
                <span class="hmi-dot" aria-hidden="true"></span><span>Open interest</span>
                <span class="hmi-dot" aria-hidden="true"></span><span>Perps vs spot</span>
                <span class="hmi-dot" aria-hidden="true"></span><span>Volatility</span>
              </div>
            </div>
          </section>

          <!-- ACTION -->
          <section class="section section--action">
            <div class="action-header-row">
              <div class="action-title-main">
                <div class="action-label">Action -</div>
                <div id="action-mode" class="action-mode">Buy</div>
              </div>
            </div>
            <div id="action-token" class="action-token">$UNI</div>
            <div id="action-line" class="action-line">Entry: $0.00 | Target: $0.00</div>
          </section>

          <!-- AGENTS -->
          <section class="section section--agents">
            <div class="section-title">Agents</div>
            <table class="agents-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Balance</th>
                  <th>ROI</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="agents-name">BTC buy and hold</td>
                  <td id="agents-btc-balance">$--.--</td>
                  <td id="agents-btc-roi">--.--%</td>
                </tr>
                <tr>
                  <td class="agents-name">Index Rebalancer</td>
                  <td id="agents-kc1-balance">$--.--</td>
                  <td id="agents-kc1-roi">--.--%</td>
                </tr>
                <tr>
                  <td class="agents-name">Knifecatcher</td>
                  <td id="agents-kc2-balance">$--.--</td>
                  <td id="agents-kc2-roi">--.--%</td>
                </tr>
              </tbody>
            </table>
          </section>
        </div>
      </section>

      <!-- ANALYTICS: Dominance + Token table -->
      <section class="analytics">
        <div class="analytics-top">
          <!-- DOMINANCE -->
          <section class="section section--dominance">
            <div class="oracle-header-row">
              <div class="section-title">Dominance</div>
              <div class="oracle-header-right">
                <div class="oracle-pill-wrapper">
                  <div class="oracle-pill" id="oracle-x-pill">
                    <span class="oracle-pill-label" id="oracle-x-label">Select</span>
                    <span class="oracle-pill-arrow">▾</span>
                  </div>
                  <div class="oracle-dropdown" id="oracle-x-menu"></div>
                </div>
                <span class="oracle-vs">vs</span>
                <div class="oracle-pill-wrapper">
                  <div class="oracle-pill" id="oracle-y-pill">
                    <span class="oracle-pill-label" id="oracle-y-label">Select</span>
                    <span class="oracle-pill-arrow">▾</span>
                  </div>
                  <div class="oracle-dropdown" id="oracle-y-menu"></div>
                </div>
              </div>
            </div>

            <div class="oracle-main-line" id="oracle-main-line">
              <span class="dom-value">--</span>
              <span class="dom-label">Select X and Y</span>
            </div>
            <div class="oracle-sub-line" id="oracle-sub-line">
              Market caps: <span>–</span>
            </div>
            <div class="oracle-range-line" id="oracle-range-line">
              Range: <span>–</span>
            </div>
            <div class="oracle-error" id="oracle-error"></div>

            <div class="oracle-chart-placeholder"></div>
          </section>
        </div>

        <!-- TOKENS -->
        <section class="prices-card">
          <div class="prices-header">
            <div class="prices-title">Tokens</div>
          </div>
          <table class="prices-table">
            <thead>
              <tr>
                <th class="token-col">Token</th>
                <th class="center">Price</th>
                <th class="center">Dom</th>
                <th class="center">Range</th>
                <th class="center">Action</th>
                <th class="center">Pot. ROI</th>
              </tr>
            </thead>
            <tbody id="prices-tbody">
            </tbody>
          </table>
        </section>

        <!-- ORACLE NOTES -->
        <section class="oracle-notes-card">
          <div class="footer-note">
            <div class="footer-note-title">HiveAI Oracle Notes</div>
            <div>
              <ul style="margin-top:6px;line-height:1.35;list-style:disc;padding-left:18px;">
                <li>Hive Mind Index (HMI) is our custom fear and greed index, factored for predictive signaling.</li>
                <li>HMI and Dom values updated hourly.</li>
                <li>'Dom' represents BTC dominance against token.</li>
                <li>'Range' represents up to 2-year BTC Dom range against token.</li>
                <li>USDTC = USDT and USDC combined.</li>
                <li>Additional token listing available on request.</li>
              </ul>
            </div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script>
    const HMI_NEUTRAL_LOW = 40;
    const HMI_NEUTRAL_HIGH = 60;

    const ORACLE_TOKENS = [
      "BTC",
      "ETH",
      "BNB",
      "SOL",
      "DOGE",
      "TON",
      "SUI",
      "UNI"
    ];

    const BINANCE_SYMBOLS = {
      BTC: "BTCUSDT",
      ETH: "ETHUSDT",
      BNB: "BNBUSDT",
      SOL: "SOLUSDT",
      DOGE: "DOGEUSDT",
      TON: "TONUSDT",
      SUI: "SUIUSDT",
      UNI: "UNIUSDT"
    };

    let pricesRowsGlobal = [];
    let suppliesGlobal = null;
    let oracleHistories = {};
    let domBandsGlobal = null;

    let oracleSelectedX = ["BTC"];   // default
    let oracleSelectedY = ["ALTS"];  // default: all alts (not BTC)

    function formatDateTime(ts) {
      if (!ts) return "--/--/-- --:--";
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yy = String(d.getFullYear()).slice(-2);
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${dd}/${mm}/${yy} ${hh}:${mi}`;
    }

    function formatMC(v) {
      if (!v || v <= 0) return "$0";
      if (v >= 1e12) {
        return `$${(v / 1e12).toFixed(1)}T`;
      }
      if (v >= 1e9) {
        return `$${Math.round(v / 1e9)}B`;
      }
      if (v >= 1e6) {
        return `$${Math.round(v / 1e6)}M`;
      }
      return `$${Math.round(v).toLocaleString()}`;
    }

    function updateLogoColor(hmi) {
      const slashEl = document.getElementById("logo-slash");
      const hiveEl = document.getElementById("logo-hive");

      if (!slashEl || !hiveEl) return;

      slashEl.classList.remove("logo-accent-red", "logo-accent-green", "logo-accent-neutral");
      hiveEl.classList.remove("logo-accent-red", "logo-accent-green", "logo-accent-neutral");

      if (typeof hmi !== "number" || Number.isNaN(hmi)) {
        slashEl.classList.add("logo-accent-neutral");
        hiveEl.classList.add("logo-accent-neutral");
        return;
      }

      if (hmi < HMI_NEUTRAL_LOW) {
        slashEl.classList.add("logo-accent-red");
        hiveEl.classList.add("logo-accent-red");
      } else if (hmi > HMI_NEUTRAL_HIGH) {
        slashEl.classList.add("logo-accent-green");
        hiveEl.classList.add("logo-accent-green");
      } else {
        slashEl.classList.add("logo-accent-neutral");
        hiveEl.classList.add("logo-accent-neutral");
      }
    }

    function hmiBandLabel(hmi) {
      if (hmi < 10) return "Zombie Apocalypse";
      if (hmi < 25) return "McDonald's Applications in high demand";
      if (hmi < 45) return "NGMI";
      if (hmi < 50) return "Leaning bearish";
      if (hmi < 55) return "Cautiously bullish";
      if (hmi < 75) return "It's digital gold";
      if (hmi < 90) return "Frothy";
      return "It's the future of finance";
    }

    function updateHmiVisual(hmi) {
      const scoreEl = document.getElementById("hmi-score");
      const statusEl = document.getElementById("hmi-status");
      const knobEl = document.getElementById("hmi-bar-knob");

      if (hmi == null || Number.isNaN(hmi)) {
        if (scoreEl) scoreEl.textContent = "--.-";
        if (statusEl) statusEl.textContent = "unavailable";
        if (knobEl) knobEl.style.left = "50%";
        updateLogoColor(NaN);
        return;
      }

      const clamped = Math.max(0, Math.min(100, hmi));
      if (scoreEl) scoreEl.textContent = hmi.toFixed(1);
      if (statusEl) statusEl.textContent = hmiBandLabel(hmi);
      if (knobEl) knobEl.style.left = `${clamped}%`;
      updateLogoColor(hmi);
    }

    async function fetchHMI() {
      try {
        const resp = await fetch("/hmi_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("HMI fetch failed");
        const data = await resp.json();

        const hmiRaw = (typeof data.hmi === "number") ? data.hmi : parseFloat(data.hmi);
        const hmi = Number.isNaN(hmiRaw) ? null : hmiRaw;

        if (hmi === null) {
          throw new Error("Invalid HMI in JSON");
        }

        updateHmiVisual(hmi);
      } catch (err) {
        console.error("HMI error:", err);
        updateHmiVisual(null);
      }
    }

    async function fetchSupplies() {
      try {
        const resp = await fetch("/supplies_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("supplies fetch failed");
        const data = await resp.json();
        suppliesGlobal = data && data.supplies ? data.supplies : null;
      } catch (err) {
        console.error("Supplies error:", err);
        suppliesGlobal = null;
      }
    }

    async function fetchOracleHistory() {
      try {
        const resp = await fetch("/dom_history_latest.json", { cache: "no-store" });
        if (!resp.ok) {
          console.warn("dom_history_latest.json not found or error");
          oracleHistories = {};
          return;
        }
        const data = await resp.json();
        oracleHistories = data && data.series ? data.series : {};
      } catch (err) {
        console.error("Oracle history error:", err);
        oracleHistories = {};
      }
    }

    async function fetchDomBands() {
      try {
        const resp = await fetch("/dom_bands_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("dom bands fetch failed");
        domBandsGlobal = await resp.json();
      } catch (err) {
        console.error("Dom bands error:", err);
        domBandsGlobal = null;
      }
    }

    function computeActionForRow(row) {
      const token = row.token;
      if (!token) return "–";

      const upToken = String(token).toUpperCase();

      if (upToken === "BTC" || upToken.includes("USD")) {
        return "–";
      }

      const domRaw = (typeof row.btc_dom === "number")
        ? row.btc_dom
        : parseFloat(row.btc_dom ?? "NaN");
      if (!Number.isFinite(domRaw)) return "–";

      const rangeStr = row.range || "";
      const m = rangeStr.match(/(\d+(?:\.\d+)?)\D+(\d+(?:\.\d+)?)%?/);
      if (!m) return "–";

      const minPct = parseFloat(m[1]);
      const maxPct = parseFloat(m[2]);
      if (!Number.isFinite(minPct) || !Number.isFinite(maxPct) || maxPct <= minPct) {
        return "–";
      }

      let pos = (domRaw - minPct) / (maxPct - minPct);
      if (!Number.isFinite(pos)) return "–";
      pos = Math.max(0, Math.min(1, pos)); 

      if (pos >= 0.4 && pos <= 0.6) {
        return "Stables";
      }

      let altPct, btcPct;

      if (pos < 0.4) {
        const t = pos / 0.4;        
        btcPct = 100 - Math.round(t * 50);
        altPct = 100 - btcPct;
      } else {
        const t = (pos - 0.6) / 0.4; 
        altPct = 50 + Math.round(t * 50);
        btcPct = 100 - altPct;
      }

      altPct = Math.max(0, Math.min(100, Math.round(altPct)));
      btcPct = 100 - altPct;

      return `${altPct}/${btcPct}`;  
    }

    function parseRangeToLowHigh(rangeStr) {
      if (!rangeStr) return null;
      const m = String(rangeStr).match(/(\d+(?:\.\d+)?)\D+(\d+(?:\.\d+)?)/);
      if (!m) return null;
      const low = parseFloat(m[1]);
      const high = parseFloat(m[2]);
      if (!(high > low)) return null;
      return { low, high };
    }

    function computeNeutralHigh(low, high) {
      const width = high - low;
      return low + 0.60 * width;
    }

    function computePotentialRoi(row, btcMcRaw) {
      const token = (row.token || "").toUpperCase();
      if (!token || token === "BTC" || token.includes("USD")) return null;

      const rangeInfo = parseRangeToLowHigh(row.range || "");
      if (!rangeInfo) return null;
      const { low, high } = rangeInfo;

      const btcMc = (typeof btcMcRaw === "number") ? btcMcRaw : parseFloat(btcMcRaw || "0");
      const altMc = (typeof row.mc === "number") ? row.mc : parseFloat(row.mc || "0");
      const priceNow = (typeof row.price === "number") ? row.price : parseFloat(row.price || "0");

      if (!(btcMc > 0 && altMc > 0 && priceNow > 0)) return null;

      const neutralHigh = computeNeutralHigh(low, high);
      const domTarget = neutralHigh / 100.0;
      if (!(domTarget > 0 && domTarget < 1)) return null;

      const sTarget = (1.0 - domTarget) / domTarget * btcMc;

      const supplyEst = altMc / priceNow;
      if (!(supplyEst > 0)) return null;

      const targetPrice = sTarget / supplyEst;
      if (!(targetPrice > 0)) return null;

      const roiFrac = targetPrice / priceNow - 1.0;
      return roiFrac;
    }

    function formatRangeTwoDecimals(rangeStr) {
      if (!rangeStr) return "–";

      const m = rangeStr.match(/(\d+(?:\.\d+)?)[^\d]+(\d+(?:\.\d+)?)/);
      if (!m) return rangeStr;

      const low = parseFloat(m[1]);
      const high = parseFloat(m[2]);

      return low.toFixed(2) + "% – " + high.toFixed(2) + "%";
    }

    async function fetchPrices() {
      try {
        const resp = await fetch("/prices_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("prices fetch failed");
        const data = await resp.json();

        const metaEl = document.getElementById("meta-date");
        if (metaEl && data && data.timestamp) {
          metaEl.textContent = formatDateTime(data.timestamp);
        }

        const tbody = document.getElementById("prices-tbody");
        tbody.innerHTML = "";

        const rows = Array.isArray(data.rows) ? data.rows : [];
        pricesRowsGlobal = rows;

        let btcMc = 0;
        for (const r of rows) {
          const tok = (r.token || "").toUpperCase();
          if (tok === "BTC") {
            const v = (typeof r.mc === "number") ? r.mc : parseFloat(r.mc || "0");
            if (!Number.isNaN(v) && v > 0) btcMc = v;
            break;
          }
        }

        rows.forEach(row => {
          const tr = document.createElement("tr");

          const tdToken = document.createElement("td");
          tdToken.className = "token-col";

          const tokenWrap = document.createElement("div");
          tokenWrap.className = "token-cell";

          const dot = document.createElement("span");
          dot.className = "token-dot token-dot-neutral";

          let change24 = null;
          if (typeof row.change_24h_pct === "number") {
            change24 = row.change_24h_pct;
          } else if (typeof row.change_24h === "number") {
            change24 = row.change_24h;
          } else if (typeof row.pct_change_24h === "number") {
            change24 = row.pct_change_24h;
          }

          if (change24 !== null && !Number.isNaN(change24)) {
            if (change24 > 0) {
              dot.className = "token-dot token-dot-positive";
            } else if (change24 < 0) {
              dot.className = "token-dot token-dot-negative";
            }
          }

          const tokenLabel = document.createElement("span");
          tokenLabel.textContent = row.token || "";

          tokenWrap.appendChild(dot);
          tokenWrap.appendChild(tokenLabel);
          tdToken.appendChild(tokenWrap);
          tr.appendChild(tdToken);

          const tdPrice = document.createElement("td");
          tdPrice.className = "center";
          const priceVal = typeof row.price === "number" ? row.price : parseFloat(row.price || "0");
          if (!Number.isNaN(priceVal) && priceVal > 0) {
            if (priceVal >= 1000) {
              tdPrice.textContent = "$" + Math.round(priceVal).toLocaleString();
            } else if (priceVal >= 1) {
              tdPrice.textContent = "$" + priceVal.toFixed(2);
            } else if (priceVal >= 0.01) {
              tdPrice.textContent = "$" + priceVal.toFixed(3);
            } else {
              tdPrice.textContent = "$" + priceVal.toFixed(6);
            }
          } else {
            tdPrice.textContent = "–";
          }
          tr.appendChild(tdPrice);

          const tdDom = document.createElement("td");
          tdDom.className = "center";
          const dom = typeof row.btc_dom === "number" ? row.btc_dom : null;
          if (dom === null || Number.isNaN(dom)) {
            tdDom.textContent = "–";
          } else {
            tdDom.textContent = dom.toFixed(1) + "%";
          }
          tr.appendChild(tdDom);

          const tdRange = document.createElement("td");
          tdRange.className = "center";
          tdRange.textContent = formatRangeTwoDecimals(row.range);
          tr.appendChild(tdRange);

          const tdAction = document.createElement("td");
          tdAction.className = "center";
          tdAction.textContent = computeActionForRow(row);
          tr.appendChild(tdAction);

          const tdRoi = document.createElement("td");
          tdRoi.className = "center";
          const roiFrac = computePotentialRoi(row, btcMc);
          if (roiFrac == null || Number.isNaN(roiFrac)) {
            tdRoi.textContent = "–";
          } else {
            const pct = roiFrac * 100;
            const sign = pct > 0 ? "+" : "";
            tdRoi.textContent = sign + pct.toFixed(1) + "%";
          }
          tr.appendChild(tdRoi);

          tbody.appendChild(tr);
        });

        buildOracleMenus();
        updateOracle();
      } catch (err) {
        console.error("Prices error:", err);
        const tbody = document.getElementById("prices-tbody");
        tbody.innerHTML = "";
      }
    }

    function setActionFromSig(sig) {
      const modeEl = document.getElementById("action-mode");
      const tokenEl = document.getElementById("action-token");
      const lineEl = document.getElementById("action-line");

      if (!modeEl || !tokenEl || !lineEl || !sig) return;

      const pos = sig.position || {};
      const type = (pos.type || "").toUpperCase();
      const token = (pos.token || "NONE").toUpperCase();
      const actionRaw = (sig.action || "BUY").toUpperCase();

      const entryPrice = (typeof pos.entry_price === "number")
        ? pos.entry_price
        : parseFloat(pos.entry_price || "NaN");

      const targetPrice = (typeof pos.target_price === "number")
        ? pos.target_price
        : parseFloat(pos.target_price || "NaN");

      const equityUsd = (typeof sig.equity_usd === "number")
        ? sig.equity_usd
        : parseFloat(sig.equity_usd || "NaN");

      function fmtUsd(x) {
        if (x == null || Number.isNaN(x)) return "--";
        return x.toFixed(2);
      }

      let modeLabel = "Buy";
      let modeColor = "var(--accent-green)";
      let bigToken = "$" + token;
      let lineText = "";

      if (type === "STABLES") {
        modeLabel = "Stable up";
        modeColor = "#ffd000";
        bigToken = "STABLES";
        lineText = "Equity: $" + fmtUsd(equityUsd);
      } else {
        if (actionRaw === "SELL") {
          modeLabel = "Sell";
          modeColor = "var(--accent-red)";
        } else if (actionRaw === "BUY" || actionRaw === "HOLD") {
          modeLabel = "Buy";
          modeColor = "var(--accent-green)";
        }
        lineText = "Entry: $" + fmtUsd(entryPrice) + " | Target: $" + fmtUsd(targetPrice);
      }

      modeEl.textContent = modeLabel;
      modeEl.style.color = modeColor;
      tokenEl.textContent = bigToken;
      lineEl.textContent = lineText;
    }

    function updateAgentsFromData(kc1Data, sig) {
      const btcBalEl = document.getElementById("agents-btc-balance");
      const btcRoiEl = document.getElementById("agents-btc-roi");
      const kc1BalEl = document.getElementById("agents-kc1-balance");
      const kc1RoiEl = document.getElementById("agents-kc1-roi");
      const kc2BalEl = document.getElementById("agents-kc2-balance");
      const kc2RoiEl = document.getElementById("agents-kc2-roi");

      function fmtPct(x) {
        if (x == null || Number.isNaN(x)) return "--.--%";
        const pct = x * 100;
        const sign = pct > 0 ? "+" : "";
        return sign + pct.toFixed(1) + "%";
      }

      function fmtUsd(x) {
        if (x == null || Number.isNaN(x)) return "$--.--";
        return "$" + x.toFixed(2);
      }

      if (kc1Data) {
        const base = typeof kc1Data.base_balance_usd === "number"
          ? kc1Data.base_balance_usd
          : parseFloat(kc1Data.base_balance_usd || "0");

        const portVal = typeof kc1Data.portfolio_value === "number"
          ? kc1Data.portfolio_value
          : parseFloat(kc1Data.portfolio_value || "0");

        let algoRoi = null;
        if (base && base > 0 && !Number.isNaN(portVal)) {
          algoRoi = (portVal / base) - 1;
        }

        if (kc1BalEl) kc1BalEl.textContent = fmtUsd(portVal);
        if (kc1RoiEl) kc1RoiEl.textContent = fmtPct(algoRoi);
      }

      if (sig && sig.benchmarks && sig.benchmarks.BTC) {
        const b = sig.benchmarks.BTC;
        const roiFrac = typeof b.roi_frac === "number"
          ? b.roi_frac
          : parseFloat(b.roi_frac || "NaN");
        const balance = 100 * (1 + (roiFrac || 0));

        if (btcBalEl) btcBalEl.textContent = fmtUsd(balance);
        if (btcRoiEl) btcRoiEl.textContent = fmtPct(roiFrac);
      }

      if (sig) {
        const equityUsd = typeof sig.equity_usd === "number"
          ? sig.equity_usd
          : parseFloat(sig.equity_usd || "NaN");

        const roiFrac = typeof sig.roi_frac === "number"
          ? sig.roi_frac
          : parseFloat(sig.roi_frac || "NaN");

        if (kc2BalEl) kc2BalEl.textContent = fmtUsd(equityUsd);
        if (kc2RoiEl) kc2RoiEl.textContent = fmtPct(roiFrac);
      }
    }

    async function fetchKnifecatcher() {
      try {
        const resp = await fetch("/knifecatcher_latest.json", { cache: "no-store" });
        if (!resp.ok) throw new Error("knifecatcher fetch failed");
        const kc1Data = await resp.json();

        try {
          const resp2 = await fetch("/dom_signals_hourly.json", { cache: "no-store" });
          if (!resp2.ok) throw new Error("dom signals fetch failed");
          const sig = await resp2.json();

          if (sig && sig.position) {
            setActionFromSig(sig);
          }

          updateAgentsFromData(kc1Data, sig);
        } catch (err2) {
          console.error("DOM signals error:", err2);
          updateAgentsFromData(kc1Data, null);
        }
      } catch (err) {
        console.error("Knifecatcher error:", err);
      }
    }

    function formatTokenLabel(token) {
      if (token === "ALTS") return "Alts";
      const lower = token.toLowerCase();
      return lower.charAt(0).toUpperCase() + lower.slice(1);
    }

    function formatTokenSetLabel(tokens) {
      if (tokens.length === 0) return "Select";
      if (tokens.includes("ALTS")) return "Alts";
      if (tokens.length === 1) return formatTokenLabel(tokens[0]);
      return tokens.map(formatTokenLabel).join("");
    }

    function getLiveMC(token) {
      const row = pricesRowsGlobal.find(r => r.token === token);
      if (!row) return 0;
      const v = row.mc;
      if (typeof v === "number") return v;
      const f = parseFloat(v || "0");
      return Number.isNaN(f) ? 0 : f;
    }

    function getHistorySeries(key) {
      if (!oracleHistories) return null;
      return oracleHistories[key] || null;
    }

    function sortTokensByMC(tokens) {
      const arr = [...tokens];
      arr.sort((a, b) => {
        const aMC = getLiveMC(a);
        const bMC = getLiveMC(b);
        if (aMC > bMC) return -1;
        if (aMC < bMC) return 1;
        return a.localeCompare(b);
      });
      return arr;
    }

    function computeOracleDomAndRange(xTokens, yTokens) {
      if (!Array.isArray(xTokens) || !Array.isArray(yTokens)) {
        return { ok: false, reason: "Missing selections" };
      }
      if (xTokens.length === 0 || yTokens.length === 0) {
        return { ok: false, reason: "Select both sides" };
      }

      const expandSide = (tokens) => {
        if (tokens.includes("ALTS")) {
          return ORACLE_TOKENS.filter(t => t !== "BTC");
        }
        return tokens;
      };

      const xSet = expandSide(xTokens);
      const ySet = expandSide(yTokens);

      const fullX = new Set(xSet);
      const fullY = new Set(ySet);

      if (fullX.size === 0 || fullY.size === 0) {
        return { ok: false, reason: "Both X and Y must have at least one token" };
      }

      const mcX = Array.from(fullX).reduce((acc, t) => acc + getLiveMC(t), 0);
      const mcY = Array.from(fullY).reduce((acc, t) => acc + getLiveMC(t), 0);

      const totalNow = mcX + mcY;
      if (totalNow <= 0) {
        return { ok: false, reason: "No market cap data" };
      }

      const domNow = (mcX / totalNow) * 100;

      const key = `${Array.from(fullX).sort().join("+")}__${Array.from(fullY).sort().join("+")}`;
      const hist = getHistorySeries(key);
      let domMin = null;
      let domMax = null;
      let days = 0;

      if (hist && Array.isArray(hist.values) && hist.values.length > 0) {
        days = hist.values.length;
        domMin = Math.min(...hist.values);
        domMax = Math.max(...hist.values);
      } else {
        const xIsBTCOnly = (xTokens.length === 1 && xTokens[0] === "BTC");
        const yIsAltsOnly = (yTokens.length === 1 && yTokens[0] === "ALTS");

        if (xIsBTCOnly && yIsAltsOnly && domBandsGlobal) {
          const mn = parseFloat(domBandsGlobal.min_pct);
          const mx = parseFloat(domBandsGlobal.max_pct);
          if (!Number.isNaN(mn) && !Number.isNaN(mx)) {
            domMin = mn;
            domMax = mx;
            days = domBandsGlobal.days || 0;
          }
        } else if (xIsBTCOnly && yTokens.length === 1 && ORACLE_TOKENS.includes(yTokens[0])) {
          const token = yTokens[0];
          const row = pricesRowsGlobal.find(r => r.token === token);
          if (row && row.range) {
            const m = String(row.range).match(/(\d+)\D+(\d+)%/);
            if (m) {
              const mn = parseFloat(m[1]);
              const mx = parseFloat(m[2]);
              if (!Number.isNaN(mn) && !Number.isNaN(mx)) {
                domMin = mn;
                domMax = mx;
              }
            }
          }
        }
      }

      const prettyName = (tokens) => {
        if (tokens.includes("ALTS")) return "Alts";
        const sorted = sortTokensByMC(tokens);
        return sorted.map(formatTokenLabel).join("");
      };

      return {
        ok: true,
        domNow,
        domMin,
        domMax,
        days,
        mcX,
        mcY,
        labelX: prettyName(xTokens),
        labelY: prettyName(yTokens),
      };
    }

    function buildOracleMenus() {
      const xMenu = document.getElementById("oracle-x-menu");
      const yMenu = document.getElementById("oracle-y-menu");
      const xLabel = document.getElementById("oracle-x-label");
      const yLabel = document.getElementById("oracle-y-label");
      const xPill = document.getElementById("oracle-x-pill");
      const yPill = document.getElementById("oracle-y-pill");

      if (!xMenu || !yMenu || !xLabel || !yLabel || !xPill || !yPill) return;

      const xOrder = ["BTC", ...ORACLE_TOKENS.filter(t => t !== "BTC")];
      const yOrder = ["ALTS", "BTC", ...ORACLE_TOKENS.filter(t => t !== "BTC")];

      const xIsPureBTC = (oracleSelectedX.length === 1 && oracleSelectedX[0] === "BTC");

      xMenu.innerHTML = "";
      yMenu.innerHTML = "";

      xOrder.forEach(tok => {
        if (tok === "ALTS") return;

        const div = document.createElement("div");
        div.className = "oracle-option";
        div.dataset.token = tok;

        const box = document.createElement("div");
        box.className = "oracle-option-box";

        const tick = document.createElement("span");
        tick.className = "oracle-option-tick";
        tick.textContent = "✓";

        const label = document.createElement("span");
        label.className = "oracle-option-label";
        label.textContent = formatTokenLabel(tok);

        box.appendChild(tick);
        div.appendChild(box);
        div.appendChild(label);

        if (oracleSelectedX.includes(tok)) {
          div.classList.add("selected");
        }

        div.addEventListener("click", (e) => {
          e.stopPropagation();
          if (tok === "BTC") {
            if (oracleSelectedX.includes("BTC")) {
              oracleSelectedX = oracleSelectedX.filter(t => t !== "BTC");
            } else {
              oracleSelectedX = ["BTC"];
            }
          } else {
            oracleSelectedX = oracleSelectedX.filter(t => t !== "BTC");
            if (oracleSelectedX.includes(tok)) {
              oracleSelectedX = oracleSelectedX.filter(t => t !== tok);
            } else {
              oracleSelectedX = [...oracleSelectedX, tok];
            }
          }
          Array.from(xMenu.querySelectorAll(".oracle-option")).forEach(opt => {
            const t = opt.dataset.token;
            opt.classList.toggle("selected", oracleSelectedX.includes(t));
          });
          xLabel.textContent = formatTokenSetLabel(oracleSelectedX);
          buildOracleMenus();
          updateOracle();
        });

        xMenu.appendChild(div);
      });

      const xClear = document.createElement("div");
      xClear.className = "oracle-clear";
      xClear.textContent = "Clear";
      xClear.addEventListener("click", (e) => {
        e.stopPropagation();
        oracleSelectedX = [];
        Array.from(xMenu.querySelectorAll(".oracle-option")).forEach(opt => {
          opt.classList.remove("selected");
        });
        xLabel.textContent = "Select";
        buildOracleMenus();
        updateOracle();
      });
      xMenu.appendChild(xClear);

      yOrder.forEach(tok => {
        if (tok === "ALTS" && !xIsPureBTC) return;

        const div = document.createElement("div");
        div.className = "oracle-option";
        div.dataset.token = tok;

        const box = document.createElement("div");
        box.className = "oracle-option-box";

        const tick = document.createElement("span");
        tick.className = "oracle-option-tick";
        tick.textContent = "✓";

        const label = document.createElement("span");
        label.className = "oracle-option-label";
        label.textContent = formatTokenLabel(tok);

        box.appendChild(tick);
        div.appendChild(box);
        div.appendChild(label);

        if (oracleSelectedY.includes(tok)) {
          div.classList.add("selected");
        }

        div.addEventListener("click", (e) => {
          e.stopPropagation();
          if (tok === "ALTS") {
            oracleSelectedY = ["ALTS"];
          } else {
            oracleSelectedY = oracleSelectedY.filter(t => t !== "ALTS");
            if (oracleSelectedY.includes(tok)) {
              oracleSelectedY = oracleSelectedY.filter(t => t !== tok);
            } else {
              oracleSelectedY = [...oracleSelectedY, tok];
            }
            if (oracleSelectedY.length === 0) {
              oracleSelectedY = [];
            }
          }
          Array.from(yMenu.querySelectorAll(".oracle-option")).forEach(opt => {
            const t = opt.dataset.token;
            opt.classList.toggle("selected", oracleSelectedY.includes(t));
          });
          yLabel.textContent = formatTokenSetLabel(oracleSelectedY);
          buildOracleMenus();
          updateOracle();
        });

        yMenu.appendChild(div);
      });

      const yClear = document.createElement("div");
      yClear.className = "oracle-clear";
      yClear.textContent = "Clear";
      yClear.addEventListener("click", (e) => {
        e.stopPropagation();
        oracleSelectedY = [];
        Array.from(yMenu.querySelectorAll(".oracle-option")).forEach(opt => {
          opt.classList.remove("selected");
        });
        yLabel.textContent = "Select";
        buildOracleMenus();
        updateOracle();
      });
      yMenu.appendChild(yClear);

      xLabel.textContent = formatTokenSetLabel(oracleSelectedX);
      yLabel.textContent = formatTokenSetLabel(oracleSelectedY);

      function closeAllDropdowns() {
        xMenu.classList.remove("open");
        yMenu.classList.remove("open");
      }

      xPill.onclick = (e) => {
        e.stopPropagation();
        const isOpen = xMenu.classList.contains("open");
        closeAllDropdowns();
        if (!isOpen) xMenu.classList.add("open");
      };
      yPill.onclick = (e) => {
        e.stopPropagation();
        const isOpen = yMenu.classList.contains("open");
        closeAllDropdowns();
        if (!isOpen) yMenu.classList.add("open");
      };

      xMenu.addEventListener("click", (e) => e.stopPropagation());
      yMenu.addEventListener("click", (e) => e.stopPropagation());

      document.addEventListener("click", () => {
        closeAllDropdowns();
      });
    }

    async function updateOracle() {
      const mainEl = document.getElementById("oracle-main-line");
      const subEl = document.getElementById("oracle-sub-line");
      const rangeEl = document.getElementById("oracle-range-line");
      const errEl = document.getElementById("oracle-error");

      if (!mainEl || !subEl || !rangeEl || !errEl) return;

      const res = computeOracleDomAndRange(oracleSelectedX, oracleSelectedY);

      if (!res.ok) {
        mainEl.innerHTML = '<span class="dom-value">--</span><span class="dom-label">Select X and Y</span>';
        subEl.innerHTML = 'Market caps: <span>–</span>';
        rangeEl.innerHTML = 'Range: <span>–</span>';
        errEl.textContent = res.reason || "";
        return;
      }

      errEl.textContent = "";

      const domVal = res.domNow;
      const domStr = domVal != null && !Number.isNaN(domVal) ? domVal.toFixed(1) : "--";

      const label = `${res.labelX} vs ${res.labelY}`;
      mainEl.innerHTML = `<span class="dom-value">${domStr}</span><span class="dom-label">${label}</span>`;

      const mcXfmt = formatMC(res.mcX || 0);
      const mcYfmt = formatMC(res.mcY || 0);
      subEl.innerHTML = `Market caps: <span>${mcXfmt} vs ${mcYfmt}</span>`;

      let rangeSpan = "–";
      if (res.domMin != null && res.domMax != null && res.domMax > res.domMin) {
        const mn = Math.round(res.domMin);
        const mx = Math.round(res.domMax);
        rangeSpan = `${mn}%–${mx}%`;
      }
      rangeEl.innerHTML = `Range: <span>${rangeSpan}</span>`;
    }

    (function init() {
      fetchHMI();
      fetchSupplies()
        .then(fetchOracleHistory)
        .then(fetchDomBands)
        .then(fetchPrices)
        .then(fetchKnifecatcher);
    })();
  </script>
</body>
</html>
