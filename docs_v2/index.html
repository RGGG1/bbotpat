<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HiveAI - All signal, no noise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <style>
    :root{
      --bg:#000;
      --text:#f5f5f7;
      --muted:#8b8d98;

      /* Binance-ish */
      --y:#f0b90b;        /* Binance yellow */
      --y2:#ffd35a;       /* lighter yellow */
      --deep:#0b0b0b;

      --red:#b0121a;
      --orange:#c85f12;
      --gray:#2a2a2a;

      --card: rgba(255,255,255,0.02);
      --line: rgba(255,255,255,0.08);

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background:var(--bg);
      color:var(--text);
      font-family:var(--font);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px 14px;
    }
    .wrap{width:100%;max-width:1040px}

    header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
      padding-bottom:10px;
      border-bottom:1px solid var(--line);
      margin-bottom:10px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .brand-title{
      font-size:22px;
      font-weight:700;
      letter-spacing:.02em;
      line-height:1;
      color:var(--y);
    }
    .brand-tag{
      font-size:12px;
      color:var(--muted);
      font-style:italic;
    }

    .meta{
      text-align:right;
      font-size:11px;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:flex-end;
      padding-top:2px;
    }
    .meta a{
      color:var(--muted);
      text-decoration:none;
      font-size:10px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .meta a:hover{color:var(--y)}

    /* Sections */
    .section{
      padding:12px 0;
      border-bottom:1px solid var(--line);
    }
    .section:last-child{border-bottom:none}

    .title-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .section-title{
      color:#fff;
      font-size:12px;
      font-weight:700;
      letter-spacing:.10em;
      text-transform:uppercase;
    }

    /* HMI */
    .hmi-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media(min-width:760px){
      .hmi-grid{
        grid-template-columns: 1.2fr .8fr;
        align-items:center;
      }
    }

    .hmi-left{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .hmi-topline{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .hmi-name{
      color:#fff;
      font-weight:700;
      font-size:14px;
      letter-spacing:.04em;
    }

    .hmi-score{
      text-align:center;
      font-size:64px;
      font-weight:800;
      line-height:1;
      margin-top:2px;
    }
    @media(max-width:480px){
      .hmi-score{font-size:60px}
    }

    /* Fear->Greed underline bar under score (kept) */
    .hmi-bar{
      width:100%;
      height:10px;
      border-radius:999px;
      background:linear-gradient(90deg, var(--red), var(--orange), var(--y2), var(--y));
      position:relative;
      overflow:hidden;
      margin-top:8px;
    }
    .hmi-bar-mask{
      position:absolute;
      right:0; top:0; bottom:0;
      background:#1a1a1a;
      opacity:.85;
    }

    .hmi-labels{
      display:flex;
      justify-content:space-between;
      color:var(--muted);
      font-size:11px;
      margin-top:6px;
    }

    .hmi-status{
      text-align:center;
      font-size:14px;
      color:#fff;
      opacity:.95;
      margin-top:2px;
    }

    .hmi-tracking{
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:11px;
      margin-top:8px;
    }
    .dot{
      width:6px;height:6px;border-radius:999px;
      background:var(--y);
      box-shadow:none;
      display:inline-block;
      margin-right:6px;
      transform:translateY(-1px);
    }

    /* ACTION */
    .action-row{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
      text-align:center;
    }
    .action-title{
      width:100%;
      display:flex;
      justify-content:flex-start;
      gap:8px;
      color:#fff;
      font-size:12px;
      font-weight:800;
      letter-spacing:.10em;
      text-transform:uppercase;
    }
    .action-title .verb{color:var(--y); font-weight:900;}
    .action-token{
      font-size:64px;
      font-weight:900;
      line-height:1;
      color:var(--y);
    }
    .action-sub{
      font-size:12px;
      color:#fff;
      opacity:.9;
    }

    /* AGENTS (table style) */
    .agents{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:8px;
    }
    .agents th{
      text-align:left;
      color:var(--muted);
      font-size:10px;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-weight:700;
      padding:8px 0;
      border-bottom:1px solid var(--line);
    }
    .agents td{
      padding:10px 0;
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .agents tr:last-child td{border-bottom:none}
    .agents .c{text-align:center}
    .pos{color:#2bd67b}
    .neg{color:#ff4b5c}

    /* DOM tool (reuse your v1 dropdown logic, but style) */
    .dom-head{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .dom-pills{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill-wrap{position:relative}
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(240,185,11,0.25);
      background:rgba(240,185,11,0.06);
      cursor:pointer;
      min-width:110px;
      font-size:11px;
      color:#fff;
    }
    .pill .label{
      max-width:120px;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .pill .arr{opacity:.8;font-size:9px}
    .vs{
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
    }

    .menu{
      position:absolute;
      top:calc(100% + 6px);
      left:0;
      z-index:50;
      background:#050505;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:12px;
      box-shadow:0 18px 50px rgba(0,0,0,0.75);
      padding:8px;
      min-width:190px;
      max-height:280px;
      overflow:auto;
      display:none;
    }
    .menu.open{display:block}
    .opt{
      display:flex; align-items:center; gap:8px;
      padding:6px 8px;
      border-radius:8px;
      cursor:pointer;
      font-size:11px;
      color:#cfcfcf;
    }
    .opt:hover{background:rgba(255,255,255,0.06)}
    .opt.selected{color:var(--y)}
    .box{
      width:14px;height:14px;border-radius:4px;
      border:1px solid rgba(255,255,255,0.25);
      display:flex;align-items:center;justify-content:center;
      font-size:10px;color:var(--y);
    }
    .tick{display:none}
    .opt.selected .tick{display:block}
    .clear{
      margin-top:8px;
      padding:6px 8px;
      border-top:1px solid rgba(255,255,255,0.08);
      text-align:right;
      font-size:10px;
      color:var(--muted);
      cursor:pointer;
    }
    .clear:hover{color:#fff}

    .dom-main{
      font-size:16px;
      font-weight:600;
      margin-top:6px;
    }
    .dom-main .val{
      font-size:40px;
      font-weight:900;
      margin-right:8px;
      color:var(--y);
    }
    .dom-sub{
      color:var(--muted);
      font-size:13px;
      margin-top:6px;
    }
    .dom-sub span{color:#fff}

    /* TOKENS */
    .tokens{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:8px;
    }
    .tokens thead th{
      color:var(--muted);
      font-size:10px;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-weight:700;
      padding:8px 0;
      border-bottom:1px solid var(--line);
    }
    .tokens td{
      padding:9px 0;
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .tokens tr:last-child td{border-bottom:none}
    .tokens .token{
      text-align:left;
      font-weight:700;
    }
    .tokens .c{text-align:center}

    /* hide-on-small helpers */
    @media(max-width:520px){
      .dom-main .val{font-size:34px}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="brand-title">HiveAI</div>
        <div class="brand-tag">All signal, no noise</div>
      </div>
      <div class="meta">
        <div>Updated: <span id="meta-date">--/--/-- --:--</span></div>
        <a href="/oracle.html">HiveAI Oracle →</a>
      </div>
    </header>

    <!-- HMI -->
    <section class="section">
      <div class="title-row">
        <div class="section-title">Hive Mind Index</div>
      </div>

      <div class="hmi-grid">
        <div class="hmi-left">
          <div class="hmi-topline">
            <div class="hmi-name" style="opacity:.9"></div>
          </div>

          <div class="hmi-score" id="hmi-value">--.-</div>

          <div class="hmi-bar" aria-hidden="true">
            <div class="hmi-bar-mask" id="hmi-bar-mask" style="width:100%"></div>
          </div>

          <div class="hmi-labels">
            <span>Fear</span>
            <span>Neutral</span>
            <span>Greed</span>
          </div>

          <div class="hmi-status" id="hmi-status">–</div>

          <div class="hmi-tracking">
            <span><span class="dot"></span>Open interest</span>
            <span><span class="dot"></span>Perps vs spot</span>
            <span><span class="dot"></span>Volatility</span>
          </div>
        </div>

        <!-- ACTION -->
        <div class="action-row">
          <div class="action-title">
            <span>Action</span>
            <span class="verb" id="action-verb">BUY</span>
          </div>

          <div class="action-token" id="action-token">$---</div>

          <div class="action-sub" id="action-prices">Entry: $--.-- | Target: $--.--</div>
        </div>
      </div>
    </section>

    <!-- AGENTS -->
    <section class="section">
      <div class="title-row">
        <div class="section-title">Agents</div>
      </div>

      <table class="agents">
        <thead>
          <tr>
            <th>Name</th>
            <th class="c">Balance</th>
            <th class="c">ROI</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>BTC buy and hold</td>
            <td class="c" id="agent-btc-bal">$--.--</td>
            <td class="c" id="agent-btc-roi">--.--%</td>
          </tr>
          <tr>
            <td>Index Rebalancer</td>
            <td class="c" id="agent-kc1-bal">$--.--</td>
            <td class="c" id="agent-kc1-roi">--.--%</td>
          </tr>
          <tr>
            <td>Knifecatcher</td>
            <td class="c" id="agent-kc2-bal">$--.--</td>
            <td class="c" id="agent-kc2-roi">--.--%</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- DOMINANCE TOOL -->
    <section class="section">
      <div class="dom-head">
        <div class="dom-pills">
          <div class="pill-wrap">
            <div class="pill" id="oracle-x-pill">
              <span class="label" id="oracle-x-label">Select</span>
              <span class="arr">▾</span>
            </div>
            <div class="menu" id="oracle-x-menu"></div>
          </div>

          <span class="vs">vs</span>

          <div class="pill-wrap">
            <div class="pill" id="oracle-y-pill">
              <span class="label" id="oracle-y-label">Select</span>
              <span class="arr">▾</span>
            </div>
            <div class="menu" id="oracle-y-menu"></div>
          </div>
        </div>
      </div>

      <div class="dom-main" id="oracle-main-line">
        <span class="val">--</span><span>Select X and Y</span>
      </div>
      <div class="dom-sub" id="oracle-sub-line">Market caps: <span>–</span></div>
      <div class="dom-sub" id="oracle-range-line">Range: <span>–</span></div>
      <div class="dom-sub" id="oracle-error" style="color:#ff4b5c"></div>
    </section>

    <!-- TOKENS -->
    <section class="section">
      <div class="title-row">
        <div class="section-title">Tokens</div>
      </div>

      <table class="tokens">
        <thead>
          <tr>
            <th style="text-align:left">Token</th>
            <th class="c">Price</th>
            <th class="c">Dom</th>
            <th class="c">Range</th>
            <th class="c">Action</th>
            <th class="c">Pot. ROI</th>
          </tr>
        </thead>
        <tbody id="prices-tbody"></tbody>
      </table>
    </section>

    <!-- ORACLES NOTES (bottom) -->
    <section class="section">
      <div class="title-row">
        <div class="section-title">Oracles</div>
      </div>
      <div style="color:var(--muted);font-size:12px;line-height:1.6">
        USDTC = USDT and USDC combined. Additional token listing available on request.
      </div>
    </section>
  </div>

  <script>
    // ===== IMPORTANT: ABSOLUTE PATHS so /v2 works =====
    const URL_HMI      = "/hmi_latest.json";
    const URL_PRICES   = "/prices_latest.json";
    const URL_BANDS    = "/dom_bands_latest.json";
    const URL_HIST     = "/dom_history_latest.json";
    const URL_KC1      = "/knifecatcher_latest.json";
    const URL_KC2      = "/dom_signals_hourly.json";

    const HMI_NEUTRAL_LOW = 40;
    const HMI_NEUTRAL_HIGH = 60;

    const ORACLE_TOKENS = ["BTC","ETH","BNB","SOL","DOGE","TON","SUI","UNI"];

    let pricesRowsGlobal = [];
    let oracleHistories = {};
    let domBandsGlobal = null;

    let oracleSelectedX = ["BTC"];
    let oracleSelectedY = ["ALTS"];

    function formatDateTime(ts) {
      if (!ts) return "--/--/-- --:--";
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yy = String(d.getFullYear()).slice(-2);
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${dd}/${mm}/${yy} ${hh}:${mi}`;
    }

    function hmiBandLabel(hmi) {
      if (hmi < 10) return "Zombie Apocalypse";
      if (hmi < 25) return "McDonald's Applications in high demand";
      if (hmi < 45) return "NGMI";
      if (hmi < 50) return "Leaning bearish";
      if (hmi < 55) return "Cautiously bullish";
      if (hmi < 75) return "It's digital gold";
      if (hmi < 90) return "Frothy";
      return "It's the future of finance";
    }

    function setHmiBar(hmi){
      const mask = document.getElementById("hmi-bar-mask");
      if(!mask) return;
      // mask width = remaining portion (100-hmi)
      const clamped = Math.max(0, Math.min(100, hmi));
      const remain = 100 - clamped;
      mask.style.width = remain + "%";
    }

    function fmtPct(frac){
      if(frac==null || Number.isNaN(frac)) return "--.--%";
      const pct = frac*100;
      const sign = pct>0 ? "+" : "";
      return sign + pct.toFixed(1) + "%";
    }
    function fmtUsd(v){
      if(v==null || Number.isNaN(v)) return "$--.--";
      return "$" + Number(v).toFixed(2);
    }

    async function fetchHMI(){
      try{
        const resp = await fetch(URL_HMI, {cache:"no-store"});
        if(!resp.ok) throw new Error("HMI fetch failed");
        const data = await resp.json();
        const hmiRaw = (typeof data.hmi==="number") ? data.hmi : parseFloat(data.hmi);
        if(!Number.isFinite(hmiRaw)) throw new Error("invalid hmi");
        document.getElementById("hmi-value").textContent = hmiRaw.toFixed(1);
        document.getElementById("hmi-status").textContent = hmiBandLabel(hmiRaw);
        setHmiBar(hmiRaw);
      }catch(e){
        console.error(e);
        document.getElementById("hmi-value").textContent="--.-";
        document.getElementById("hmi-status").textContent="unavailable";
        setHmiBar(0);
      }
    }

    function formatMC(v) {
      if (!v || v <= 0) return "$0";
      if (v >= 1e12) return `$${(v/1e12).toFixed(1)}T`;
      if (v >= 1e9)  return `$${Math.round(v/1e9)}B`;
      if (v >= 1e6)  return `$${Math.round(v/1e6)}M`;
      return `$${Math.round(v).toLocaleString()}`;
    }

    async function fetchOracleHistory(){
      try{
        const resp = await fetch(URL_HIST, {cache:"no-store"});
        if(!resp.ok){
          oracleHistories = {};
          return;
        }
        const data = await resp.json();
        oracleHistories = (data && data.series) ? data.series : {};
      }catch(e){
        oracleHistories = {};
      }
    }

    async function fetchDomBands(){
      try{
        const resp = await fetch(URL_BANDS, {cache:"no-store"});
        if(!resp.ok) throw new Error("bands failed");
        domBandsGlobal = await resp.json();
      }catch(e){
        domBandsGlobal = null;
      }
    }

    function getLiveMC(token){
      const row = pricesRowsGlobal.find(r => (r.token||"").toUpperCase()===token);
      if(!row) return 0;
      const v = row.mc;
      if(typeof v==="number") return v;
      const f = parseFloat(v||"0");
      return Number.isNaN(f)?0:f;
    }

    function getHistorySeries(key){
      return oracleHistories ? (oracleHistories[key] || null) : null;
    }

    function formatTokenLabel(token){
      if(token==="ALTS") return "Alts";
      const lower = token.toLowerCase();
      return lower.charAt(0).toUpperCase() + lower.slice(1);
    }

    function formatTokenSetLabel(tokens){
      if(tokens.length===0) return "Select";
      if(tokens.includes("ALTS")) return "Alts";
      if(tokens.length===1) return formatTokenLabel(tokens[0]);
      return tokens.map(formatTokenLabel).join("");
    }

    function computeOracleDomAndRange(xTokens,yTokens){
      if(!xTokens?.length || !yTokens?.length) return {ok:false, reason:"Select both sides"};

      const expand = (arr)=>{
        if(arr.includes("ALTS")) return ORACLE_TOKENS.filter(t=>t!=="BTC");
        return arr;
      };
      const xSet = new Set(expand(xTokens));
      const ySet = new Set(expand(yTokens));
      if(xSet.size===0 || ySet.size===0) return {ok:false, reason:"Both sides need tokens"};

      const mcX = Array.from(xSet).reduce((a,t)=>a+getLiveMC(t),0);
      const mcY = Array.from(ySet).reduce((a,t)=>a+getLiveMC(t),0);
      const tot = mcX+mcY;
      if(tot<=0) return {ok:false, reason:"No market cap data"};
      const domNow = (mcX/tot)*100;

      const key = `${Array.from(xSet).sort().join("+")}__${Array.from(ySet).sort().join("+")}`;
      const hist = getHistorySeries(key);

      let domMin=null, domMax=null, days=0;
      if(hist?.values?.length){
        days = hist.values.length;
        domMin = Math.min(...hist.values);
        domMax = Math.max(...hist.values);
      }else{
        const xIsBTCOnly = (xTokens.length===1 && xTokens[0]==="BTC");
        const yIsAltsOnly = (yTokens.length===1 && yTokens[0]==="ALTS");
        if(xIsBTCOnly && yIsAltsOnly && domBandsGlobal){
          const mn = parseFloat(domBandsGlobal.min_pct);
          const mx = parseFloat(domBandsGlobal.max_pct);
          if(Number.isFinite(mn)&&Number.isFinite(mx)){
            domMin=mn; domMax=mx; days=domBandsGlobal.days||0;
          }
        }
      }

      return {
        ok:true,
        domNow, domMin, domMax, days, mcX, mcY,
        labelX: formatTokenSetLabel(xTokens),
        labelY: formatTokenSetLabel(yTokens)
      };
    }

    function buildOracleMenus(){
      const xMenu=document.getElementById("oracle-x-menu");
      const yMenu=document.getElementById("oracle-y-menu");
      const xLabel=document.getElementById("oracle-x-label");
      const yLabel=document.getElementById("oracle-y-label");
      const xPill=document.getElementById("oracle-x-pill");
      const yPill=document.getElementById("oracle-y-pill");
      if(!xMenu||!yMenu||!xLabel||!yLabel||!xPill||!yPill) return;

      const xOrder=["BTC",...ORACLE_TOKENS.filter(t=>t!=="BTC")];
      const yOrder=["ALTS","BTC",...ORACLE_TOKENS.filter(t=>t!=="BTC")];
      const xIsPureBTC=(oracleSelectedX.length===1 && oracleSelectedX[0]==="BTC");

      xMenu.innerHTML=""; yMenu.innerHTML="";

      const makeOpt = (tok, side)=>{
        const div=document.createElement("div");
        div.className="opt";
        div.dataset.token=tok;

        const box=document.createElement("div");
        box.className="box";
        const tick=document.createElement("span");
        tick.className="tick";
        tick.textContent="✓";
        box.appendChild(tick);

        const label=document.createElement("span");
        label.textContent=formatTokenLabel(tok);

        div.appendChild(box);
        div.appendChild(label);

        const selected = (side==="x" ? oracleSelectedX.includes(tok) : oracleSelectedY.includes(tok));
        if(selected) div.classList.add("selected");

        div.addEventListener("click",(e)=>{
          e.stopPropagation();
          if(side==="x"){
            if(tok==="BTC"){
              oracleSelectedX = oracleSelectedX.includes("BTC") ? oracleSelectedX.filter(t=>t!=="BTC") : ["BTC"];
            }else{
              oracleSelectedX = oracleSelectedX.filter(t=>t!=="BTC");
              oracleSelectedX = oracleSelectedX.includes(tok) ? oracleSelectedX.filter(t=>t!==tok) : [...oracleSelectedX, tok];
            }
          }else{
            if(tok==="ALTS"){
              oracleSelectedY=["ALTS"];
            }else{
              oracleSelectedY = oracleSelectedY.filter(t=>t!=="ALTS");
              oracleSelectedY = oracleSelectedY.includes(tok) ? oracleSelectedY.filter(t=>t!==tok) : [...oracleSelectedY, tok];
            }
          }
          buildOracleMenus();
          updateOracle();
        });

        return div;
      };

      xOrder.forEach(tok=>{
        if(tok==="ALTS") return;
        xMenu.appendChild(makeOpt(tok,"x"));
      });
      const xClear=document.createElement("div");
      xClear.className="clear";
      xClear.textContent="Clear";
      xClear.onclick=(e)=>{e.stopPropagation(); oracleSelectedX=[]; buildOracleMenus(); updateOracle();};
      xMenu.appendChild(xClear);

      yOrder.forEach(tok=>{
        if(tok==="ALTS" && !xIsPureBTC) return;
        yMenu.appendChild(makeOpt(tok,"y"));
      });
      const yClear=document.createElement("div");
      yClear.className="clear";
      yClear.textContent="Clear";
      yClear.onclick=(e)=>{e.stopPropagation(); oracleSelectedY=[]; buildOracleMenus(); updateOracle();};
      yMenu.appendChild(yClear);

      xLabel.textContent=formatTokenSetLabel(oracleSelectedX);
      yLabel.textContent=formatTokenSetLabel(oracleSelectedY);

      function closeAll(){xMenu.classList.remove("open"); yMenu.classList.remove("open");}
      xPill.onclick=(e)=>{e.stopPropagation(); const open=xMenu.classList.contains("open"); closeAll(); if(!open) xMenu.classList.add("open");};
      yPill.onclick=(e)=>{e.stopPropagation(); const open=yMenu.classList.contains("open"); closeAll(); if(!open) yMenu.classList.add("open");};
      document.addEventListener("click", closeAll);
    }

    function updateOracle(){
      const main=document.getElementById("oracle-main-line");
      const sub=document.getElementById("oracle-sub-line");
      const rng=document.getElementById("oracle-range-line");
      const err=document.getElementById("oracle-error");
      if(!main||!sub||!rng||!err) return;

      const res=computeOracleDomAndRange(oracleSelectedX, oracleSelectedY);
      if(!res.ok){
        main.innerHTML='<span class="val">--</span><span>Select X and Y</span>';
        sub.innerHTML='Market caps: <span>–</span>';
        rng.innerHTML='Range: <span>–</span>';
        err.textContent=res.reason||"";
        return;
      }
      err.textContent="";

      const domStr = Number.isFinite(res.domNow) ? res.domNow.toFixed(1) : "--";
      main.innerHTML = `<span class="val">${domStr}</span><span>${res.labelX} vs ${res.labelY}</span>`;

      sub.innerHTML = `Market caps: <span>${formatMC(res.mcX)} vs ${formatMC(res.mcY)}</span>`;

      let rangeSpan="–";
      if(res.domMin!=null && res.domMax!=null && res.domMax>res.domMin){
        rangeSpan = `${Math.round(res.domMin)}%–${Math.round(res.domMax)}%`;
      }
      rng.innerHTML = `Range: <span>${rangeSpan}</span>`;
    }

    function parseRangeToLowHigh(rangeStr){
      if(!rangeStr) return null;
      const m=String(rangeStr).match(/(\d+(?:\.\d+)?)[^\d]+(\d+(?:\.\d+)?)/);
      if(!m) return null;
      const low=parseFloat(m[1]), high=parseFloat(m[2]);
      if(!(high>low)) return null;
      return {low,high};
    }
    function computeNeutralHigh(low,high){
      const width=high-low;
      return low + 0.60*width;
    }
    function computePotentialRoi(row, btcMc){
      const token=(row.token||"").toUpperCase();
      if(!token || token==="BTC" || token.includes("USD")) return null;

      const rangeInfo=parseRangeToLowHigh(row.range||"");
      if(!rangeInfo) return null;
      const {low,high}=rangeInfo;

      const altMc = (typeof row.mc==="number") ? row.mc : parseFloat(row.mc||"0");
      const priceNow = (typeof row.price==="number") ? row.price : parseFloat(row.price||"0");
      if(!(btcMc>0 && altMc>0 && priceNow>0)) return null;

      const neutralHigh = computeNeutralHigh(low,high);
      const domTarget = neutralHigh/100.0;
      if(!(domTarget>0 && domTarget<1)) return null;

      const sTarget = (1-domTarget)/domTarget * btcMc;
      const supplyEst = altMc/priceNow;
      if(!(supplyEst>0)) return null;

      const targetPrice = sTarget/supplyEst;
      if(!(targetPrice>0)) return null;

      return (targetPrice/priceNow)-1;
    }

    function formatRangeTwoDecimals(rangeStr){
      if(!rangeStr) return "–";
      const m=String(rangeStr).match(/(\d+(?:\.\d+)?)[^\d]+(\d+(?:\.\d+)?)/);
      if(!m) return rangeStr;
      const low=parseFloat(m[1]), high=parseFloat(m[2]);
      if(!Number.isFinite(low)||!Number.isFinite(high)) return rangeStr;
      return low.toFixed(2) + "% – " + high.toFixed(2) + "%";
    }

    function computeActionForRow(row){
      const token = row.token;
      if(!token) return "–";
      const up=String(token).toUpperCase();
      if(up==="BTC" || up.includes("USD")) return "–";

      const domRaw = (typeof row.btc_dom==="number") ? row.btc_dom : parseFloat(row.btc_dom ?? "NaN");
      if(!Number.isFinite(domRaw)) return "–";

      const info = parseRangeToLowHigh(row.range||"");
      if(!info) return "–";
      const {low,high}=info;

      let pos=(domRaw-low)/(high-low);
      if(!Number.isFinite(pos)) return "–";
      pos=Math.max(0,Math.min(1,pos));

      if(pos>=0.4 && pos<=0.6) return "Stables";

      let altPct, btcPct;
      if(pos<0.4){
        const t=pos/0.4;
        btcPct = 100 - Math.round(t*50);
        altPct = 100 - btcPct;
      }else{
        const t=(pos-0.6)/0.4;
        altPct = 50 + Math.round(t*50);
        btcPct = 100 - altPct;
      }
      altPct=Math.max(0,Math.min(100,Math.round(altPct)));
      btcPct=100-altPct;
      return `${altPct}/${btcPct}`;
    }

    async function fetchPrices(){
      try{
        const resp=await fetch(URL_PRICES,{cache:"no-store"});
        if(!resp.ok) throw new Error("prices failed");
        const data=await resp.json();

        if(data?.timestamp){
          document.getElementById("meta-date").textContent = formatDateTime(data.timestamp);
        }

        const rows = Array.isArray(data.rows) ? data.rows : [];
        pricesRowsGlobal = rows;

        // BTC mc for Pot ROI
        let btcMc=0;
        for(const r of rows){
          if((r.token||"").toUpperCase()==="BTC"){
            const v=(typeof r.mc==="number") ? r.mc : parseFloat(r.mc||"0");
            if(Number.isFinite(v)&&v>0) btcMc=v;
          }
        }

        const tbody=document.getElementById("prices-tbody");
        tbody.innerHTML="";

        for(const row of rows){
          const tr=document.createElement("tr");

          const tdT=document.createElement("td");
          tdT.className="token";
          tdT.textContent=row.token||"";
          tr.appendChild(tdT);

          const tdP=document.createElement("td");
          tdP.className="c";
          const priceVal = (typeof row.price==="number") ? row.price : parseFloat(row.price||"0");
          if(Number.isFinite(priceVal) && priceVal>0){
            if(priceVal>=1000) tdP.textContent="$"+Math.round(priceVal).toLocaleString();
            else if(priceVal>=1) tdP.textContent="$"+priceVal.toFixed(2);
            else if(priceVal>=0.01) tdP.textContent="$"+priceVal.toFixed(3);
            else tdP.textContent="$"+priceVal.toFixed(6);
          }else tdP.textContent="–";
          tr.appendChild(tdP);

          const tdD=document.createElement("td");
          tdD.className="c";
          const domVal=(typeof row.btc_dom==="number") ? row.btc_dom : parseFloat(row.btc_dom||"NaN");
          tdD.textContent = Number.isFinite(domVal) ? domVal.toFixed(1)+"%" : "–";
          tr.appendChild(tdD);

          const tdR=document.createElement("td");
          tdR.className="c";
          tdR.textContent = formatRangeTwoDecimals(row.range);
          tr.appendChild(tdR);

          const tdA=document.createElement("td");
          tdA.className="c";
          tdA.textContent = computeActionForRow(row);
          tr.appendChild(tdA);

          const tdROI=document.createElement("td");
          tdROI.className="c";
          const roiFrac=computePotentialRoi(row, btcMc);
          if(roiFrac==null || Number.isNaN(roiFrac)) tdROI.textContent="–";
          else{
            const pct=roiFrac*100;
            const sign=pct>0?"+":"";
            tdROI.textContent=sign + pct.toFixed(1) + "%";
          }
          tr.appendChild(tdROI);

          tbody.appendChild(tr);
        }

        buildOracleMenus();
        updateOracle();
      }catch(e){
        console.error(e);
      }
    }

    async function fetchAgentsAndAction(){
      try{
        // KC1 (Index rebalancer) + BTC baseline
        const r1=await fetch(URL_KC1,{cache:"no-store"});
        if(!r1.ok) throw new Error("kc1 failed");
        const kc1=await r1.json();

        const base = (typeof kc1.base_balance_usd==="number") ? kc1.base_balance_usd : parseFloat(kc1.base_balance_usd||"0");
        const portVal = (typeof kc1.portfolio_value==="number") ? kc1.portfolio_value : parseFloat(kc1.portfolio_value||"NaN");
        const btcVal  = (typeof kc1.btc_value==="number") ? kc1.btc_value : parseFloat(kc1.btc_value||"NaN");

        let kc1Roi=null, btcRoi=null;
        if(base>0 && Number.isFinite(portVal) && Number.isFinite(btcVal)){
          kc1Roi = (portVal/base)-1;
          btcRoi = (btcVal/base)-1;
        }

        document.getElementById("agent-kc1-bal").textContent = Number.isFinite(portVal) ? fmtUsd(portVal) : "$--.--";
        document.getElementById("agent-kc1-roi").textContent = fmtPct(kc1Roi);

        // BTC buy & hold line: assume $100 start as you requested
        const btcBal = 100 * (1 + (btcRoi||0));
        document.getElementById("agent-btc-bal").textContent = Number.isFinite(btcBal) ? fmtUsd(btcBal) : "$--.--";
        document.getElementById("agent-btc-roi").textContent = fmtPct(btcRoi);

        // KC2 (Knifecatcher) + action section from KC2 position
        const r2=await fetch(URL_KC2,{cache:"no-store"});
        if(!r2.ok) throw new Error("kc2 failed");
        const kc2=await r2.json();

        const eq = (typeof kc2.equity_usd==="number") ? kc2.equity_usd : parseFloat(kc2.equity_usd||"NaN");
        const kc2Roi = (typeof kc2.roi_frac==="number") ? kc2.roi_frac : parseFloat(kc2.roi_frac||"NaN");

        document.getElementById("agent-kc2-bal").textContent = Number.isFinite(eq) ? fmtUsd(eq) : "$--.--";
        document.getElementById("agent-kc2-roi").textContent = fmtPct(kc2Roi);

        // ACTION: always green/yellow BUY format (your latest instruction)
        const pos = kc2.position || {};
        const token = (pos.token || "STABLES").toString().toUpperCase();
        const entry = (typeof pos.entry_price==="number") ? pos.entry_price : parseFloat(pos.entry_price||"NaN");
        const target= (typeof pos.target_price==="number") ? pos.target_price : parseFloat(pos.target_price||"NaN");

        document.getElementById("action-verb").textContent = "BUY";
        document.getElementById("action-token").textContent = "$" + token;

        const entryStr = Number.isFinite(entry) ? entry.toFixed(2) : "--.--";
        const targetStr= Number.isFinite(target) ? target.toFixed(2) : "--.--";
        document.getElementById("action-prices").textContent = `Entry: $${entryStr} | Target: $${targetStr}`;

      }catch(e){
        console.error(e);
      }
    }

    (function init(){
      fetchHMI();
      fetchOracleHistory()
        .then(fetchDomBands)
        .then(fetchPrices)
        .then(fetchAgentsAndAction);
    })();
  </script>
</body>
</html>
