trade_id += 1  # bump on publish
#!/usr/bin/env python3
import json, time, csv
from pathlib import Path
from datetime import datetime, timezone


def _load_last_trade_id(path="/var/www/bbotpat_live/kc3_latest.json"):
    try:
        import json
        with open(path, "r") as f:
            d = json.load(f)
        return int(d.get("trade_id") or 0)
    except Exception:
        return 0

WEBROOT = Path("/var/www/bbotpat_live")
HMI_PATH = WEBROOT / "hmi_latest.json"
PRICES_PATH = WEBROOT / "prices_latest.json"
KC3_OUT = WEBROOT / "kc3_latest.json"
KC3_CSV = WEBROOT / "kc3_paper_trades.csv"

HMI_THRESHOLD = 0.1
EXCLUDE = {"BTC", "USDT", "USDC", "USDTC"}

def utc_now_iso():
    return datetime.now(timezone.utc).isoformat().replace("+00:00", "Z")

def safe_float(x):
    try:
        if x is None:
            return None
        return float(x)
    except Exception:
        return None

def read_json(path: Path):
    try:
        return json.loads(path.read_text(encoding="utf-8"))
    except Exception:
        return {}

def atomic_write(path: Path, data: dict):
    tmp = path.with_suffix(path.suffix + ".tmp")
    tmp.write_text(json.dumps(data, indent=2) + "\n", encoding="utf-8")
    tmp.replace(path)

class KC3PaperAgent:
    def __init__(self):
        self.prev_hmi = None
        self.anchor_hmi = None
        self.signal_side = "LONG"
        self.trade_id = 0
        self.last_log = 0.0

    def best_token_from_prices(self, prices_js: dict):
        rows = prices_js.get("rows", [])
        best_tok, best_pot = None, None

        for r in rows:
            tok = str(r.get("token","")).upper().strip()
            if not tok or tok in EXCLUDE:
                continue

            pot = safe_float(r.get("pot_roi_pct"))
            if pot is None:
                frac = safe_float(r.get("pot_roi_frac"))
                if frac is None:
                    continue
                pot = frac * 100.0

            if best_pot is None or pot > best_pot:
                best_tok, best_pot = tok, pot

        return best_tok, best_pot

    def compute_delta(self, hmi):
        if self.prev_hmi is None:
            return None
        return hmi - self.prev_hmi

    def update_signal_anchor_flip(self, hmi):
        if self.anchor_hmi is None:
            self.anchor_hmi = hmi
            return False

        move = hmi - self.anchor_hmi
        if abs(move) >= HMI_THRESHOLD:
            old = self.signal_side
            self.signal_side = "LONG" if move > 0 else "SHORT"
            self.anchor_hmi = hmi
            self.trade_id += 1
            print(f"[{utc_now_iso()}] FLIP {old} -> {self.signal_side} (move={move:.6f}, anchor={self.anchor_hmi:.6f})", flush=True)
            return True
        return False

    def append_csv(self, out: dict):
        new = not KC3_CSV.exists()
        with KC3_CSV.open("a", newline="", encoding="utf-8") as f:
            w = csv.writer(f)
            if new:
                w.writerow(["ts","hmi","hmi_delta","signal_side","best_token","best_pot_roi_pct","trade_id"])
            w.writerow([out["timestamp"], out["hmi"], out["hmi_delta"], out["signal_side"],
                        out["best_token"], out["best_pot_roi_pct"], out["trade_id"]])

    def step(self):
        hmi_js = read_json(HMI_PATH)
        prices_js = read_json(PRICES_PATH)

        hmi = safe_float(hmi_js.get("hmi"))
        if hmi is None:
            return

        best_tok, best_pot = self.best_token_from_prices(prices_js)
        hmi_delta = self.compute_delta(hmi)

        self.update_signal_anchor_flip(hmi)

        out = {
            "timestamp": utc_now_iso(),
            "hmi": hmi,
            "hmi_delta": (None if hmi_delta is None else round(hmi_delta, 6)),
            "signal_side": self.signal_side,
            "best_token": best_tok,
            "best_pot_roi_pct": best_pot,
            "trade_id": self.trade_id,
        }

        atomic_write(KC3_OUT, out)
        self.append_csv(out)
        self.prev_hmi = hmi

        now = time.time()
        if now - self.last_log >= 15:
            self.last_log = now
            print(f"[{out['timestamp']}] hmi={out['hmi']} delta={out['hmi_delta']} side={out['signal_side']} best={out['best_token']} pot={out['best_pot_roi_pct']} trade_id={out['trade_id']}", flush=True)

def main():
    agent = KC3PaperAgent()
    while True:
        agent.step()
        time.sleep(1)

if __name__ == "__main__":
    main()
