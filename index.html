<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HiveAI – Hive Mind Index & Dominance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <style>
    :root {
      --bg: #000000;
      --bg-elevated: transparent;
      --border-subtle: transparent;
      --text-main: #f5f5f7;
      --text-muted: #888aa0;
      --accent-red: #ff4b5c;
      --accent-green: #4dff88;
      --accent-neutral: #ffffff;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
                   "Inter", "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: #000000;
      color: var(--text-main);
      font-family: var(--font-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 32px 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1040px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .site-title {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    #logo-slash {
      font-size: 24px;
      line-height: 1;
      transform: translateY(-1px);
    }

    .logo-accent-red {
      color: var(--accent-red);
    }

    .logo-accent-green {
      color: var(--accent-green);
    }

    .logo-accent-neutral {
      color: var(--accent-neutral);
    }

    .meta-topline {
      text-align: right;
      font-size: 13px;
      color: var(--text-muted);
    }

    .meta-topline strong {
      color: var(--text-main);
      font-weight: 500;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.3fr);
      gap: 18px;
    }

    @media (max-width: 800px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .meta-topline {
        text-align: left;
      }
    }

    .card {
      background: transparent;
      border-radius: 0;
      border: none;
      box-shadow: none;
      padding: 6px 2px 10px;
    }

    .card:not(:first-of-type) {
      margin-top: 4px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #181828;
      border: 1px solid #262637;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }

    .hmi-value-row {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 10px;
    }

    .hmi-value {
      font-size: 40px;
      font-weight: 600;
    }

    .hmi-status {
      font-size: 14px;
      color: var(--text-muted);
    }

    .dominance-main {
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .dominance-range {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .dominance-sub {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .dominance-sub span {
      color: var(--text-main);
    }

    .prices-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .prices-list strong {
      color: var(--text-main);
      font-weight: 500;
    }

    .dominance-action {
      margin-top: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .footer-note {
      margin-top: 18px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
      justify-content: flex-start;
      align-items: flex-start;
    }

    .status-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-right: 4px;
    }

    .status-live {
      background: var(--accent-green);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <h1 class="site-title">
        <span id="logo-slash" class="logo-accent-neutral">/</span>
        <span id="logo-hive" class="logo-accent-neutral">HiveAI</span>
      </h1>
      <div class="meta-topline">
        <strong id="meta-date">--/--/--</strong>
      </div>
    </header>

    <main>
      <!-- HMI CARD -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">Hive Mind Index</div>
          <!-- chip removed here -->
        </div>
        <div class="hmi-value-row">
          <span class="hmi-value" id="hmi-value">--.-</span>
          <span class="hmi-status" id="hmi-status">unavailable</span>
        </div>
      </section>

      <!-- DOMINANCE CARD -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">Dominance</div>
          <div class="chip" id="dom-chip-label">BTC vs EthBnbSol</div>
        </div>
        <div class="dominance-main" id="dom-main-text">
          BTC vs EthBnbSol: --/--
        </div>
        <div class="dominance-range" id="dom-range-text">
          2-yr range: –% - –%
        </div>
        <div class="dominance-sub" id="dom-sub-text">
          Market caps: <span>–</span>
        </div>
        <div class="prices-list">
          <div id="price-btc">BTC: <strong>–</strong></div>
          <div id="price-eth">ETH: <strong>–</strong></div>
          <div id="price-bnb">BNB: <strong>–</strong></div>
          <div id="price-sol">SOL: <strong>–</strong></div>
        </div>
        <div class="dominance-action" id="dom-action-text">
          Action: –
        </div>
      </section>
    </main>

    <div class="footer-note">
      <div>
        <span class="status-dot status-live"></span>Refresh rates
      </div>
      <div>HMI: every 60s.</div>
      <div>Dominance: every 6h.</div>
      <div>Prices: on page load.</div>
    </div>
  </div>

  <script>
    // ---- CONFIG ----
    const HMI_SOURCE_URL = "hmi_latest.json";           // generated by export_hmi_json.py at repo root
    const DOM_BANDS_URL  = "dom_bands_latest.json";     // generated by backtest_dominance_rotation.py
    const HMI_REFRESH_MS = 60 * 1000;                   // 1 minute
    const DOM_REFRESH_MS = 6 * 60 * 60 * 1000;          // 6 hours

    const HMI_NEUTRAL_LOW = 40;
    const HMI_NEUTRAL_HIGH = 60;
    const GREED_STABLE_THRESHOLD = 77.0;

    // ---- GLOBAL STATE FOR ACTION ----
    let latestHmi = null;
    let domMin = null;
    let dom35 = null;
    let dom65 = null;
    let domMax = null;
    let latestBtcDom = null;

    // ---- UTILITIES ----
    function formatDate(ts) {
      const d = ts ? new Date(ts) : new Date();
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yy = String(d.getFullYear()).slice(-2);
      return `${dd}/${mm}/${yy}`;
    }

    function formatMarketCap(v) {
      if (!v || v <= 0) return "$0";
      if (v >= 1e12) {
        return `$${(v / 1e12).toFixed(1)}T`;
      }
      if (v >= 1e9) {
        return `$${Math.round(v / 1e9)}B`;
      }
      if (v >= 1e6) {
        return `$${Math.round(v / 1e6)}M`;
      }
      return `$${Math.round(v).toLocaleString()}`;
    }

    function hmiBandLabel(hmi) {
      if (hmi < 10) return "Zombie apocalypse";
      if (hmi < 25) return "McDonald's applications";
      if (hmi < 40) return "Ngmi";
      if (hmi < 60) return "Stable";
      if (hmi < 80) return "We're early";
      return "It's the future of finance";
    }

    function updateLogoColor(hmi) {
      const slashEl = document.getElementById("logo-slash");
      const hiveEl = document.getElementById("logo-hive");

      // Reset
      slashEl.classList.remove("logo-accent-red", "logo-accent-green", "logo-accent-neutral");
      hiveEl.classList.remove("logo-accent-red", "logo-accent-green", "logo-accent-neutral");

      // Decide band: below neutral = red, neutral = white, above = green
      if (hmi < HMI_NEUTRAL_LOW) {
        slashEl.classList.add("logo-accent-red");
        hiveEl.classList.add("logo-accent-red");
      } else if (hmi > HMI_NEUTRAL_HIGH) {
        slashEl.classList.add("logo-accent-green");
        hiveEl.classList.add("logo-accent-green");
      } else {
        slashEl.classList.add("logo-accent-neutral");
        hiveEl.classList.add("logo-accent-neutral");
      }
    }

    // ---- ACTION CALC ----
    function updateActionText() {
      const el = document.getElementById("dom-action-text");

      // Need dominance, bands, and HMI
      if (
        latestBtcDom === null ||
        domMin === null || dom35 === null || dom65 === null || domMax === null
      ) {
        el.textContent = "Action: –";
        return;
      }

      // HMI greed override
      if (latestHmi !== null && latestHmi >= GREED_STABLE_THRESHOLD) {
        el.textContent = "Action: Stable up";
        return;
      }

      // Mid-zone stables
      if (latestBtcDom > dom35 && latestBtcDom < dom65) {
        el.textContent = "Action: Stable up";
        return;
      }

      // Degenerate guard
      if (domMax <= domMin) {
        el.textContent = "Action: –";
        return;
      }

      // Linear BTC -> ALTs mapping across domMin -> domMax
      let t = (latestBtcDom - domMin) / (domMax - domMin);
      t = Math.max(0, Math.min(1, t));

      // t < 0.5 => BTC-heavy, t > 0.5 => ALTs-heavy
      if (t <= 0.5) {
        el.textContent = "Action: Buy BTC";
      } else {
        el.textContent = "Action: Buy ALTs";
      }
    }

    // ---- HMI FETCH ----
    async function fetchHMI() {
      try {
        const resp = await fetch(HMI_SOURCE_URL, { cache: "no-store" });
        if (!resp.ok) throw new Error("HMI fetch failed");
        const data = await resp.json();

        const hmi = typeof data.hmi === "number" ? data.hmi : parseFloat(data.hmi);
        if (Number.isNaN(hmi)) throw new Error("Invalid HMI in JSON");

        latestHmi = hmi;

        const band = hmiBandLabel(hmi);

        document.getElementById("hmi-value").textContent = hmi.toFixed(1);
        document.getElementById("hmi-status").textContent = band.toLowerCase();
        document.getElementById("meta-date").textContent = formatDate();

        updateLogoColor(hmi);
        updateActionText();
      } catch (err) {
        console.error("HMI error:", err);
        document.getElementById("hmi-value").textContent = "--.-";
        document.getElementById("hmi-status").textContent = "unavailable";
      }
    }

    // ---- DOMINANCE BANDS (dynamic) ----
    async function fetchDomBands() {
      try {
        const resp = await fetch(DOM_BANDS_URL, { cache: "no-store" });
        if (!resp.ok) throw new Error("dom bands fetch failed");
        const data = await resp.json();

        domMin = typeof data.dom_min === "number" ? data.dom_min : parseFloat(data.dom_min);
        dom35  = typeof data.dom_35 === "number" ? data.dom_35 : parseFloat(data.dom_35);
        dom65  = typeof data.dom_65 === "number" ? data.dom_65 : parseFloat(data.dom_65);
        domMax = typeof data.dom_max === "number" ? data.dom_max : parseFloat(data.dom_max);

        if (
          Number.isNaN(domMin) || Number.isNaN(dom35) ||
          Number.isNaN(dom65) || Number.isNaN(domMax)
        ) {
          throw new Error("Invalid dom bands in JSON");
        }

        const minPct = Math.round(domMin * 100);
        const maxPct = Math.round(domMax * 100);

        const text = `2-yr range: ${minPct}% - ${maxPct}%`;
        document.getElementById("dom-range-text").textContent = text;

        updateActionText();
      } catch (err) {
        console.error("Dominance bands error:", err);
        document.getElementById("dom-range-text").textContent =
          "2-yr range: unavailable";
      }
    }

    // ---- DOMINANCE & PRICES ----
    async function fetchDominanceAndPrices() {
      try {
        const url = "https://api.coingecko.com/api/v3/coins/markets" +
          "?vs_currency=usd&ids=bitcoin,ethereum,binancecoin,solana" +
          "&per_page=4&page=1";

        const resp = await fetch(url, { cache: "no-store" });
        if (!resp.ok) throw new Error("Dominance fetch failed");
        const rows = await resp.json();

        const byId = {};
        rows.forEach(r => { byId[r.id] = r; });

        const btc = byId["bitcoin"];
        const eth = byId["ethereum"];
        const bnb = byId["binancecoin"];
        const sol = byId["solana"];

        const btcMc = btc?.market_cap || 0;
        const altMc = (eth?.market_cap || 0) + (bnb?.market_cap || 0) + (sol?.market_cap || 0);

        let btcDom = 0.5;
        if (btcMc + altMc > 0) {
          btcDom = btcMc / (btcMc + altMc);
        }
        latestBtcDom = btcDom;

        const btcPct = Math.round(btcDom * 100);
        const altPct = 100 - btcPct;

        document.getElementById("dom-main-text").textContent =
          `BTC vs EthBnbSol: ${btcPct}/${altPct}`;

        const capsText = `${formatMarketCap(btcMc)} vs ${formatMarketCap(altMc)}`;
        document.getElementById("dom-sub-text").innerHTML =
          `Market caps: <span>${capsText}</span>`;

        // Prices (vertical)
        document.getElementById("price-btc").innerHTML =
          `BTC: <strong>$${Math.round(btc?.current_price || 0).toLocaleString()}</strong>`;
        document.getElementById("price-eth").innerHTML =
          `ETH: <strong>$${Math.round(eth?.current_price || 0).toLocaleString()}</strong>`;
        document.getElementById("price-bnb").innerHTML =
          `BNB: <strong>$${Math.round(bnb?.current_price || 0).toLocaleString()}</strong>`;
        document.getElementById("price-sol").innerHTML =
          `SOL: <strong>$${(sol?.current_price || 0).toFixed(2)}</strong>`;

        updateActionText();
      } catch (err) {
        console.error("Dominance error:", err);
        document.getElementById("dom-main-text").textContent =
          "BTC vs EthBnbSol: --/--";
        document.getElementById("dom-sub-text").innerHTML =
          "Market caps: <span>unavailable</span>";
      }
    }

    // ---- INIT ----
    (function init() {
      document.getElementById("meta-date").textContent = formatDate();

      // HMI refresh: now + every 60s
      fetchHMI();
      setInterval(fetchHMI, HMI_REFRESH_MS);

      // Dominance bands: fetch now + every 6h
      fetchDomBands();
      setInterval(fetchDomBands, DOM_REFRESH_MS);

      // Prices + dominance: fetch immediately, then every 6h
      fetchDominanceAndPrices();
      setInterval(fetchDominanceAndPrices, DOM_REFRESH_MS);
    })();
  </script>
</body>
</html>
