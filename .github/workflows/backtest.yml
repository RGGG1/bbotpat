name: Extreme Outlier Backtest

on:
  workflow_dispatch:
    inputs:
      symbols:
        description: "Space-separated symbols"
        required: false
        default: "BTCUSDT ETHUSDT SOLUSDT"
      start:
        description: "Start date (YYYY-MM-DD)"
        required: false
        default: "2023-01-01"
      end:
        description: "End date (YYYY-MM-DD or 'now')"
        required: false
        default: "now"
      fee_bps:
        description: "Fee bps per side (no leverage)"
        required: false
        default: "8"
      exchange:
        description: "CCXT exchange id"
        required: false
        default: "okx"
      side:
        description: "Trade side"
        required: false
        default: "both"
      utc_hours:
        description: "Comma-separated UTC hours (empty=all)"
        required: false
        default: "13,14,15,16,17,18,19,20"
      vol_pctl_min:
        description: "Regime: min vol percentile (0-100, empty=off)"
        required: false
        default: "40"
      vol_lookback:
        description: "Vol lookback bars"
        required: false
        default: "336"
      dynamic_z_ref:
        description: "Dynamic scaling reference |Z| (empty=off)"
        required: false
        default: "3.5"
      dynamic_scale_min:
        description: "Dynamic scale min"
        required: false
        default: "0.8"
      dynamic_scale_max:
        description: "Dynamic scale max"
        required: false
        default: "1.6"
      confirm_map:
        description: "Cross-confirm map e.g. 'SOLUSDT:BTCUSDT,ETHUSDT:BTCUSDT' (empty=off)"
        required: false
        default: "SOLUSDT:BTCUSDT,ETHUSDT:BTCUSDT"
      confirm_z:
        description: "Confirm Z"
        required: false
        default: "2.5"
      confirm_mode:
        description: "Confirm mode (opposite|same)"
        required: false
        default: "opposite"

jobs:
  backtest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy ccxt python-dateutil

      - name: Run backtest
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          python .github/analyze_extreme_outliers.py \
            --symbols ${{ github.event.inputs.symbols }} \
            --start ${{ github.event.inputs.start }} \
            --end ${{ github.event.inputs.end }} \
            --fee-bps ${{ github.event.inputs.fee_bps }} \
            --exchange ${{ github.event.inputs.exchange }} \
            --side ${{ github.event.inputs.side }} \
            --utc-hours "${{ github.event.inputs.utc_hours }}" \
            --vol-pctl-min ${{ github.event.inputs.vol_pctl_min }} \
            --vol-lookback ${{ github.event.inputs.vol_lookback }} \
            --dynamic-z-ref ${{ github.event.inputs.dynamic_z_ref }} \
            --dynamic-scale-min ${{ github.event.inputs.dynamic_scale_min }} \
            --dynamic-scale-max ${{ github.event.inputs.dynamic_scale_max }} \
            --confirm-map "${{ github.event.inputs.confirm_map }}" \
            --confirm-z ${{ github.event.inputs.confirm_z }} \
            --confirm-mode ${{ github.event.inputs.confirm_mode }} \
            --print-top 7
