#!/usr/bin/env python3
import json, os, time
from datetime import datetime, timezone
from pathlib import Path
from urllib.request import urlopen, Request
from urllib.parse import urlencode

WEBROOT = Path("/var/www/bbotpat_live")
OUT = WEBROOT / "prices_latest.json"
OUT.parent.mkdir(parents=True, exist_ok=True)

SPOT_URL = "https://api.binance.com/api/v3/ticker/price"
FUT_URL  = "https://fapi.binance.com/fapi/v1/ticker/price"
POLL_SEC = float(os.getenv("LIVE_COLLECTOR_POLL_SEC", "1.0"))

DEFAULT_TOKENS = [
    "UNI","SOL","ETH","BNB","DOGE","TON","SUI",
    "XRP","TRX","ADA","LINK","XMR","XLM","ZEC","LTC","AVAX","HYPE","WLFI",
]

def utc():
    return datetime.now(timezone.utc).isoformat().replace("+00:00","Z")

def norm_tokens(s: str):
    s = (s or "").strip().replace(",", " ")
    s = " ".join(s.split())
    toks = [t.upper() for t in s.split()] if s else []
    toks = [t for t in toks if t and t != "SHIB"]
    seen=set(); out=[]
    for t in toks:
        if t not in seen:
            out.append(t); seen.add(t)
    return out

def http_get_json(url: str, params: dict):
    qs = urlencode(params)
    req = Request(url + "?" + qs, headers={"User-Agent":"bbotpat-live-collector"})
    with urlopen(req, timeout=10) as r:
        return json.loads(r.read().decode("utf-8"))

def fetch_prices(symbols):
    payload = {"symbols": json.dumps(symbols)}
    try:
        return http_get_json(SPOT_URL, payload), "spot"
    except Exception:
        return http_get_json(FUT_URL, payload), "futures"

def write_json_atomic(path: Path, obj):
    tmp = path.with_suffix(".tmp")
    tmp.write_text(json.dumps(obj, indent=2) + "\n", encoding="utf-8")
    tmp.replace(path)

def main():
    tokens_env = os.getenv("KC3_ALT_LIST", "")
    toks = norm_tokens(tokens_env) if tokens_env.strip() else DEFAULT_TOKENS[:]
    want = ["BTC"] + toks
    symbols = ["BTCUSDT"] + [f"{t}USDT" for t in toks]

    while True:
        t0 = time.time()
        try:
            data, src = fetch_prices(symbols)
            mp = {}
            if isinstance(data, list):
                for it in data:
                    sym = it.get("symbol")
                    px = it.get("price")
                    if sym and px is not None:
                        try:
                            mp[sym] = float(px)
                        except Exception:
                            pass

            rows = []
            btc = mp.get("BTCUSDT")
            if btc and btc > 0:
                rows.append({"token":"BTC","price":btc,"mc":None,"change_24h":None,"btc_dom":None,"range":None,"action":None,"pot_roi_frac":None})

            for t in toks:
                px = mp.get(f"{t}USDT")
                if px and px > 0:
                    rows.append({"token":t,"price":px,"mc":None,"change_24h":None,"btc_dom":None,"range":None,"action":None,"pot_roi_frac":None})

            missing = []
            if not btc:
                missing.append("BTC")
            for t in toks:
                if f"{t}USDT" not in mp:
                    missing.append(t)

            payload = {"timestamp": utc(), "rows": rows, "src": src, "missing": missing}
            write_json_atomic(OUT, payload)
        except Exception as e:
            payload = {"timestamp": utc(), "rows": [], "src": "error", "err": repr(e)}
            write_json_atomic(OUT, payload)

        dt = time.time() - t0
        time.sleep(max(0.2, POLL_SEC - dt))

if __name__ == "__main__":
    main()
